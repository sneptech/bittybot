# Sprint 7 Plan — Context Limit Handling + Polish

**Date:** 2026-02-28
**Branch:** `mowismtest`
**Basis:** Sprint 7 Report (on-device retest of Sprint 6)

---

## Summary

Sprint 6 retest passed 3/6 fixes, confirmed frame skips are Flutter/Impeller (not Dart-fixable), and found 1 new bug (BUG-8: `[Context limit reached]` in chat bubble). Sprint 7 addresses BUG-8, adds a native splash screen to cover frame skips, and strips quote wrapping from translations.

## Critical Discovery: nCtx Mismatch

`chat_notifier.dart` and `translation_notifier.dart` both use `_kNCtx = 2048` for context-full detection, but the actual model context is `nCtx = 512` (set in `inference_message.dart:31`). This means context-full detection NEVER fires (it checks 2048*0.9=1843 tokens, but the model maxes out at 512). This is why BUG-8 happens — the model hits the real 512 limit with no Dart-side interception.

The `[Context limit reached]` string is likely generated by llama.cpp / llama_cpp_dart when the context window is exhausted, and our token filter doesn't catch it because it's not a special token pattern.

---

## Task Assignments

### RoseFinch (Pane 1) → Workers Pane 3 + Pane 4

**Pane 3 Worker: S7-T1 + S7-T4 (Context limit handling)**
These are closely related — both involve chat_notifier.dart context exhaustion.

**Pane 4 Worker: S7-T3 (Translation quote stripping)**

### WindyRobin (Pane 2) → Worker Pane 5

**Pane 5 Worker: S7-T2 (Native splash screen)**

---

## Task Specifications

### S7-T1 (P2): Handle context limit gracefully — Pane 3

**Problem:** `[Context limit reached]` text appears in chat bubble as model output when nCtx=512 is exhausted. Also, `_kNCtx` is set to 2048 instead of 512, so context-full detection never fires.

**Files to modify:**
- `lib/features/chat/application/chat_notifier.dart`

**Changes:**
1. Fix `_kNCtx` from 2048 to 512 (line 21) — must match actual nCtx in `inference_message.dart:31`
2. In `_finishGeneration()`, strip `[Context limit reached]` from the assistant content before persisting:
   ```dart
   final content = state.currentResponse
       .replaceAll('[Context limit reached]', '')
       .trimRight();
   ```
3. If stripping leaves empty content, do NOT persist an empty assistant message

**Test:** Send 7+ messages in a session. Context-full banner should appear BEFORE the model hits the hard limit. `[Context limit reached]` should never be visible in a bubble.

### S7-T4 (P2): Empty response feedback — Pane 3

**Problem:** When context is fully exhausted, subsequent messages produce 0-token responses with no feedback to the user.

**Files to modify:**
- `lib/features/chat/application/chat_notifier.dart`

**Changes:**
1. In `_finishGeneration()`, after the content stripping from S7-T1: if `tokenCount == 0` (from DoneResponse) AND content is empty, auto-start a new session:
   - Call `startNewSession()` to clear context
   - Set `isContextFull = true` to signal the UI
2. Alternative: In `_onResponse` for `DoneResponse`, check `tokenCount == 0` and trigger a context reset

**Note:** `DoneResponse` already carries `tokenCount`. The `_finishGeneration` method needs to accept it.

### S7-T2 (P3): Native splash screen — Pane 5

**Problem:** 183-243 frame skips during Flutter/Impeller Vulkan init cause ~3s blank screen on cold start. Cannot be fixed from Dart — need native Android splash.

**Files to modify:**
- `android/app/src/main/res/drawable/launch_background.xml`
- `android/app/src/main/res/drawable-v21/launch_background.xml`
- `android/app/src/main/res/values/styles.xml`
- `android/app/src/main/res/values-night/styles.xml`

**Changes:**
1. Update `launch_background.xml` (both drawable and drawable-v21) to show the BittyBot logo centered on a dark background:
   - Background: `#121212` (AppColors.surface) for both light and dark variants
   - Center the `@mipmap/ic_launcher` bitmap
2. Update `styles.xml` LaunchTheme to use dark background (`Theme.Black.NoTitleBar` for both light and night)
3. Uncomment and configure the `<bitmap>` item in the layer-list

**Dark-only rationale:** The app uses a dark theme exclusively (`buildDarkTheme()`), so the splash should match.

**layer-list example:**
```xml
<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:drawable="@color/splash_background" />
    <item>
        <bitmap
            android:gravity="center"
            android:src="@mipmap/ic_launcher" />
    </item>
</layer-list>
```

May need to create `res/values/colors.xml` with `<color name="splash_background">#121212</color>`.

### S7-T3 (P3): Strip quote wrapping from translations — Pane 4

**Problem:** Model wraps some translations in quotes ("Buenos dias") but not others (Gracias.).

**Files to modify:**
- `lib/features/translation/application/translation_notifier.dart`

**Changes:**
1. In `_finishTranslation()`, post-process `state.translatedText` to strip leading/trailing quotes before persisting:
   ```dart
   final content = state.translatedText
       .replaceAll(RegExp(r'^["\'«»""'']+|["\'«»""'']+$'), '')
       .trim();
   ```
2. Also update `state.translatedText` with the stripped version so the UI shows clean text

**Test:** Translate "Good morning" to Spanish — should show `Buenos dias` not `"Buenos dias"`.

---

## Also fix in both notifiers

**`_kNCtx` mismatch in `translation_notifier.dart`:** Line 19 also has `_kNCtx = 2048`. Change to 512 as well, matching the actual model context size.

---

## Commit Style

- `fix(chat): [S7-T1] handle context limit text in chat bubbles`
- `fix(chat): [S7-T4] auto-reset on zero-token response`
- `feat(android): [S7-T2] add branded native splash screen`
- `fix(translation): [S7-T3] strip quote wrapping from translations`
