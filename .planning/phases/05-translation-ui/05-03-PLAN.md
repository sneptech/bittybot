---
phase: 05-translation-ui
plan: "03"
type: execute
wave: 3
depends_on:
  - "05-02"
files_modified:
  - lib/features/translation/presentation/widgets/language_picker_sheet.dart
  - lib/features/translation/presentation/widgets/language_grid_item.dart
  - lib/features/translation/presentation/translation_screen.dart
autonomous: true
requirements:
  - TRNS-02
  - TRNS-04

must_haves:
  truths:
    - "User can open the language picker by tapping the target language button in the top bar"
    - "Language picker shows all 66 Tiny Aya languages in a searchable 3-column grid with flag icons"
    - "Popular languages (10) are pinned at the top of the picker"
    - "Rolling history of last 3 used languages appears for quick access"
    - "Search matches both localized name and English name"
    - "Selecting a language closes the picker and updates the target language"
    - "Long-pressing a translation bubble shows a copy option that writes to clipboard"
  artifacts:
    - path: "lib/features/translation/presentation/widgets/language_picker_sheet.dart"
      provides: "DraggableScrollableSheet with search, popular section, rolling history, and 3-column grid"
      contains: "LanguagePickerSheet"
    - path: "lib/features/translation/presentation/widgets/language_grid_item.dart"
      provides: "Individual language button with flag icon and language name"
      contains: "LanguageGridItem"
  key_links:
    - from: "lib/features/translation/presentation/translation_screen.dart"
      to: "lib/features/translation/presentation/widgets/language_picker_sheet.dart"
      via: "showModalBottomSheet() on target language button tap"
      pattern: "showModalBottomSheet"
    - from: "lib/features/translation/presentation/widgets/language_picker_sheet.dart"
      to: "lib/features/translation/application/translation_notifier.dart"
      via: "setTargetLanguage() on language selection"
      pattern: "setTargetLanguage"
    - from: "lib/features/translation/presentation/widgets/language_grid_item.dart"
      to: "country_flags"
      via: "CountryFlag.fromCountryCode() for flag icons"
      pattern: "CountryFlag"
    - from: "lib/features/translation/presentation/widgets/translation_bubble_list.dart"
      to: "flutter/services.dart"
      via: "Clipboard.setData() on long-press copy"
      pattern: "Clipboard.setData"
---

<objective>
Build the language picker bottom sheet (with search, 3-column flag grid, popular languages, rolling history) and add long-press copy support on translation bubbles. Wire the language picker into the TranslationScreen's target language button.

Purpose: TRNS-02 (language selection from 70+ languages) and TRNS-04 (copy to clipboard) are the remaining functional requirements. The language picker is the most complex UI component in Phase 5.

Output: Fully functional language picker with search/filter, flag icons, localized names, popular/recent sections, and clipboard copy on translation bubbles.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-translation-ui/05-CONTEXT.md
@.planning/phases/05-translation-ui/05-RESEARCH.md
@.planning/phases/05-translation-ui/05-01-SUMMARY.md
@.planning/phases/05-translation-ui/05-02-SUMMARY.md

# Existing code references
@lib/features/translation/presentation/translation_screen.dart
@lib/features/translation/presentation/widgets/translation_bubble_list.dart
@lib/features/translation/data/language_data.dart
@lib/features/translation/domain/supported_language.dart
@lib/features/translation/application/translation_notifier.dart
@lib/features/settings/application/settings_provider.dart
@lib/core/theme/app_colors.dart
@lib/core/l10n/app_localizations.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Language picker bottom sheet with search, grid, flags, popular, and recent sections</name>
  <files>
    lib/features/translation/presentation/widgets/language_picker_sheet.dart
    lib/features/translation/presentation/widgets/language_grid_item.dart
  </files>
  <action>
**1. Create LanguageGridItem (`lib/features/translation/presentation/widgets/language_grid_item.dart`):**

A `StatelessWidget` rendering a single language entry in the grid:

```dart
class LanguageGridItem extends StatelessWidget {
  final SupportedLanguage language;
  final String displayName;  // Localized name from flutter_localized_locales
  final String countryCode;  // Resolved country code (with device locale variant)
  final bool isSelected;     // Highlight currently selected language
  final VoidCallback onTap;
  ...
}
```

Layout (vertical stack within a Material inkwell):
1. `CountryFlag.fromCountryCode(countryCode, height: 24, width: 32, shape: RoundedRectangle(4))` — flag icon
2. `SizedBox(height: 4)`
3. `Text(displayName)` — localized language name, `bodySmall`, centered, max 2 lines with overflow ellipsis

Styling:
- Background: `isSelected ? AppColors.primaryContainer : Colors.transparent`
- Border radius: 8dp
- Padding: `EdgeInsetsDirectional.all(8)`
- Min height: 72dp (48dp tap target + spacing)
- Use `InkWell` for tap feedback

**2. Create LanguagePickerSheet (`lib/features/translation/presentation/widgets/language_picker_sheet.dart`):**

A `ConsumerStatefulWidget` (owns search `TextEditingController` and filter state):

**Parameters:**
```dart
class LanguagePickerSheet extends ConsumerStatefulWidget {
  final ScrollController scrollController;  // From DraggableScrollableSheet
  final String currentLanguage;  // Currently selected target language
  final ValueChanged<SupportedLanguage> onLanguageSelected;
  ...
}
```

**State:**
- `_searchQuery` (String) — current search filter
- `_filteredLanguages` (List<SupportedLanguage>) — recomputed on query change

**Layout (Column inside the sheet):**

1. **Handle bar** — 4dp height, 32dp width, centered, `AppColors.onSurfaceVariant` with 50% opacity, 2dp border radius. Standard drag indicator.

2. **Search bar** — `TextField` with `Icons.search` prefix icon, `l10n.searchLanguages` hint, `onChanged: _updateSearch`. Padding: `EdgeInsetsDirectional.fromSTEB(16, 8, 16, 8)`.

3. **Scrollable body** — `Expanded` → `CustomScrollView` using the `scrollController` from the DraggableScrollableSheet (critical for scroll conflict avoidance — research Pitfall 4):

   a. **Recent languages section** (conditional — only if `recentTargetLanguages` from settings is non-empty):
      - `SliverToBoxAdapter` with label `l10n.recentLanguages` in `titleSmall` style
      - `SliverToBoxAdapter` with a `Row` of up to 3 compact language chips (flag + name in a `FilterChip` or styled `ActionChip`)
      - Only show if search query is empty (hide during search)

   b. **Popular languages section** (only when search query is empty):
      - `SliverToBoxAdapter` with label `l10n.popularLanguages` in `titleSmall` style
      - `SliverGrid` with `crossAxisCount: 3` showing the 10 popular languages from `kPopularLanguages`, filtered to matching `SupportedLanguage` entries

   c. **All languages section:**
      - `SliverToBoxAdapter` with divider (when popular section was shown)
      - `SliverGrid` with `crossAxisCount: 3`, `childAspectRatio: 0.85` (slightly taller than wide to fit flag + text), showing all filtered languages sorted alphabetically
      - Uses `ClampingScrollPhysics()` (research Pitfall 4 — avoid scroll conflict with DraggableScrollableSheet)

**Search filtering:**
- `_updateSearch(String query)` — filter `kSupportedLanguages` where either:
  - `lang.englishName.toLowerCase().contains(query.toLowerCase())` OR
  - `localizedName.toLowerCase().contains(query.toLowerCase())` (get localized name from `LocaleNames.of(context)!.nameOf(lang.code) ?? lang.englishName`)
- Cache the localized names on first build (compute once, not per rebuild)

**Localized name resolution:**
- Use `LocaleNames.of(context)!.nameOf(lang.code)` to get the language name in the user's device locale.
- Fallback to `lang.englishName` if `nameOf` returns null.
- Cache the mapping in a `late Map<String, String> _localizedNames` computed in `didChangeDependencies()` (depends on BuildContext for `LocaleNames.of(context)`).

**Country code resolution:**
- Use `resolveCountryCode(lang, Localizations.localeOf(context))` from `language_data.dart` to get the correct flag variant for the device locale.

**On language selection:**
- Call `widget.onLanguageSelected(lang)`
- The parent (TranslationScreen) handles `Navigator.pop(context)` and calls `ref.read(translationNotifierProvider.notifier).setTargetLanguage(lang.englishName)`

**Sheet appearance:**
- Background color: `AppColors.surface` with rounded top corners (radius 16dp)
- `showModalBottomSheet` wrapper (created by TranslationScreen, not this widget) uses `isScrollControlled: true`, `backgroundColor: Colors.transparent`

**DraggableScrollableSheet config:**
- `initialChildSize: 0.7`
- `minChildSize: 0.4`
- `maxChildSize: 0.95`
- `expand: false`
  </action>
  <verify>
`/home/max/Android/flutter/bin/flutter analyze` passes. `grep -c 'CountryFlag' lib/features/translation/presentation/widgets/language_grid_item.dart` returns at least 1. `grep -c 'DraggableScrollableSheet\|CustomScrollView\|SliverGrid' lib/features/translation/presentation/widgets/language_picker_sheet.dart` returns at least 2. `grep -c 'LocaleNames' lib/features/translation/presentation/widgets/language_picker_sheet.dart` returns at least 1.
  </verify>
  <done>
LanguagePickerSheet is a DraggableScrollableSheet with search bar, recent languages (from settings), popular languages (pinned top 10), and full 3-column grid of all 66 languages. Each grid item shows a country flag (with device locale variant resolution) and localized language name. Search matches both English and localized names. LanguageGridItem renders flag + name with proper tap target and selection highlight.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire language picker into TranslationScreen and add long-press copy to bubbles</name>
  <files>
    lib/features/translation/presentation/translation_screen.dart
    lib/features/translation/presentation/widgets/translation_bubble_list.dart
  </files>
  <action>
**1. Wire language picker into TranslationScreen:**

In `translation_screen.dart`, update the target language button in the AppBar to open the language picker:

```dart
void _showLanguagePicker(BuildContext context) {
  showModalBottomSheet(
    context: context,
    isScrollControlled: true,
    backgroundColor: Colors.transparent,
    builder: (context) => DraggableScrollableSheet(
      initialChildSize: 0.7,
      minChildSize: 0.4,
      maxChildSize: 0.95,
      expand: false,
      builder: (context, scrollController) => LanguagePickerSheet(
        scrollController: scrollController,
        currentLanguage: ref.read(translationNotifierProvider).targetLanguage,
        onLanguageSelected: (lang) {
          Navigator.pop(context);
          ref.read(translationNotifierProvider.notifier)
             .setTargetLanguage(lang.englishName);
        },
      ),
    ),
  );
}
```

Update the target language button in the AppBar from the Plan 02 placeholder to call `_showLanguagePicker(context)` on tap.

The button should show the current language name and a dropdown arrow icon:
```dart
TextButton.icon(
  onPressed: () => _showLanguagePicker(context),
  icon: Text(state.targetLanguage, style: textTheme.titleMedium),
  label: const Icon(Icons.arrow_drop_down, size: 20),
)
```

**2. Add long-press copy support to translation bubbles:**

In `translation_bubble_list.dart`, wrap each assistant bubble (role: 'assistant') in a `GestureDetector` with `onLongPress`:

```dart
GestureDetector(
  onLongPress: () => _showBubbleMenu(context, message),
  child: _buildAssistantBubble(message),
)
```

Implement `_showBubbleMenu`:
```dart
void _showBubbleMenu(BuildContext context, ChatMessage message) {
  final l10n = AppLocalizations.of(context);
  showModalBottomSheet(
    context: context,
    builder: (_) => SafeArea(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          ListTile(
            leading: const Icon(Icons.copy),
            title: Text(l10n.copyTranslation),
            onTap: () async {
              await Clipboard.setData(ClipboardData(text: message.content));
              if (context.mounted) {
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(l10n.copied),
                    duration: const Duration(seconds: 1),
                  ),
                );
              }
            },
          ),
        ],
      ),
    ),
  );
}
```

Import `package:flutter/services.dart` for `Clipboard`.

Also add long-press copy to the streaming bubble (the one from `state.translatedText`) — but only when `!state.isTranslating` (don't interrupt streaming). The streaming bubble becomes a "completed" bubble once streaming stops, so copy should work on the final text.

For user bubbles: also support long-press copy (users may want to copy their own input).
  </action>
  <verify>
`/home/max/Android/flutter/bin/flutter analyze` passes. `grep -c 'showModalBottomSheet' lib/features/translation/presentation/translation_screen.dart` returns at least 1. `grep -c 'Clipboard.setData' lib/features/translation/presentation/widgets/translation_bubble_list.dart` returns at least 1. `grep -c 'LanguagePickerSheet' lib/features/translation/presentation/translation_screen.dart` returns at least 1.
  </verify>
  <done>
Target language button opens a DraggableScrollableSheet language picker. Selecting a language updates TranslationNotifier and closes the picker. Long-pressing any translation bubble (user or assistant) shows a copy menu that writes to clipboard with a brief "Copied" snackbar confirmation.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors
2. Tapping target language button opens language picker bottom sheet
3. Language picker shows search bar, recent languages, popular languages, and full 3-column grid
4. Search filters by both English and localized names
5. Each grid item shows a country flag (with locale variant) and localized language name
6. Selecting a language calls setTargetLanguage() and closes the sheet
7. Long-pressing an assistant bubble shows copy menu
8. Copying writes to clipboard and shows "Copied" snackbar
9. Popular languages (10) are pinned at the top of the grid
10. Recent languages (up to 3) appear as chips when available
</verification>

<success_criteria>
- Language picker opens as a DraggableScrollableSheet from the target language button
- All 66 Tiny Aya languages are displayed in a searchable 3-column grid with flag icons
- Search matches both localized and English names (e.g., "esp" and "span" both find Spanish)
- Popular languages pinned at top, recent languages shown as quick-access chips
- Flag icons resolve device locale variants (e.g., es_CO shows Colombia flag for Spanish)
- Long-press copy on translation bubbles works and provides visual feedback
- All styling uses AppColors, all text uses AppLocalizations, all padding uses EdgeInsetsDirectional
</success_criteria>

<output>
After completion, create `.planning/phases/05-translation-ui/05-03-SUMMARY.md`
</output>
