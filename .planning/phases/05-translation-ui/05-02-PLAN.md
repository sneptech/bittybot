---
phase: 05-translation-ui
plan: "02"
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - lib/widgets/main_shell.dart
  - lib/app.dart
  - lib/features/translation/presentation/translation_screen.dart
  - lib/features/translation/presentation/widgets/translation_bubble_list.dart
  - lib/features/translation/presentation/widgets/translation_input_bar.dart
  - lib/features/translation/presentation/widgets/typing_indicator.dart
autonomous: true
requirements:
  - TRNS-01
  - TRNS-03

must_haves:
  truths:
    - "User can type text in the input bar and tap Send to trigger a translation"
    - "User messages appear as right-aligned chat bubbles"
    - "Model translation appears as left-aligned chat bubbles with target language tag"
    - "Typing indicator (pulsing dots) shows while waiting for first token"
    - "Send button transforms to stop button during streaming; tapping stops generation"
    - "Translation screen has a new session button in the top bar"
    - "Bottom navigation bar shows Translate and Chat (placeholder) tabs"
    - "Empty state shows centered prompt text that disappears on first message"
  artifacts:
    - path: "lib/widgets/main_shell.dart"
      provides: "NavigationBar shell with Translate and Chat tabs using IndexedStack"
      contains: "NavigationBar"
    - path: "lib/features/translation/presentation/translation_screen.dart"
      provides: "Translation screen scaffold with AppBar (language button, new session), bubble list, input bar"
      contains: "TranslationScreen"
    - path: "lib/features/translation/presentation/widgets/translation_bubble_list.dart"
      provides: "ListView of user and assistant bubbles with word-level batching display"
      contains: "TranslationBubbleList"
    - path: "lib/features/translation/presentation/widgets/translation_input_bar.dart"
      provides: "Multi-line expandable TextField with send/stop toggle button"
      contains: "TranslationInputBar"
    - path: "lib/features/translation/presentation/widgets/typing_indicator.dart"
      provides: "iMessage-style animated pulsing dots typing indicator"
      contains: "TypingIndicator"
  key_links:
    - from: "lib/features/translation/presentation/translation_screen.dart"
      to: "lib/features/translation/application/translation_notifier.dart"
      via: "ref.watch(translationNotifierProvider) for state, ref.read(...notifier) for actions"
      pattern: "translationNotifierProvider"
    - from: "lib/features/translation/presentation/widgets/translation_bubble_list.dart"
      to: "lib/features/translation/application/session_messages_provider.dart"
      via: "ref.watch(sessionMessagesProvider(sessionId)) for DB messages"
      pattern: "sessionMessagesProvider"
    - from: "lib/features/translation/presentation/widgets/translation_input_bar.dart"
      to: "lib/features/translation/application/translation_notifier.dart"
      via: "translate() on send, stopTranslation() on stop button"
      pattern: "translate|stopTranslation"
    - from: "lib/widgets/main_shell.dart"
      to: "lib/features/translation/presentation/translation_screen.dart"
      via: "IndexedStack child at index 0"
      pattern: "TranslationScreen"
---

<objective>
Build the core translation UI: replace the MainShell placeholder with a NavigationBar shell (Translate + Chat tabs), create the TranslationScreen with chat-style bubble list, multi-line expandable input bar with send/stop toggle, iMessage-style typing indicator, word-level token batching display, auto-scroll, empty state, context-full banner, and new session button.

Purpose: This is the primary user-facing screen where translation happens. It consumes the TranslationNotifier from Phase 4 and the foundation providers from Plan 01. After this plan, users can type text and see streaming translations in a chat-style interface.

Output: Functional translation screen with all core interaction patterns (send, stop, stream display, auto-scroll, new session).
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-translation-ui/05-CONTEXT.md
@.planning/phases/05-translation-ui/05-RESEARCH.md
@.planning/phases/05-translation-ui/05-01-SUMMARY.md

# Existing code references
@lib/widgets/main_shell.dart
@lib/app.dart
@lib/features/translation/application/translation_notifier.dart
@lib/features/translation/application/session_messages_provider.dart
@lib/features/translation/domain/supported_language.dart
@lib/features/translation/data/language_data.dart
@lib/core/theme/app_colors.dart
@lib/core/theme/app_theme.dart
@lib/core/l10n/app_localizations.dart
@lib/features/chat/domain/chat_message.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Navigation shell and typing indicator</name>
  <files>
    lib/widgets/main_shell.dart
    lib/app.dart
    lib/features/translation/presentation/widgets/typing_indicator.dart
  </files>
  <action>
**1. Replace MainShell with NavigationBar shell:**

Rewrite `lib/widgets/main_shell.dart` to be a `ConsumerStatefulWidget` (needs StatefulWidget for `_selectedIndex`):

```dart
class MainShell extends ConsumerStatefulWidget {
  const MainShell({super.key});
  @override
  ConsumerState<MainShell> createState() => _MainShellState();
}

class _MainShellState extends ConsumerState<MainShell> {
  int _selectedIndex = 0;  // 0 = Translate, 1 = Chat (placeholder)

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      body: IndexedStack(
        index: _selectedIndex,
        children: [
          const TranslationScreen(),
          // Phase 6 Chat screen — placeholder for now
          Center(
            child: Text(
              l10n.chat,
              style: Theme.of(context).textTheme.headlineMedium,
            ),
          ),
        ],
      ),
      bottomNavigationBar: NavigationBar(
        selectedIndex: _selectedIndex,
        onDestinationSelected: (i) => setState(() => _selectedIndex = i),
        destinations: [
          NavigationDestination(
            icon: const Icon(Icons.translate),
            label: l10n.translate,
          ),
          NavigationDestination(
            icon: const Icon(Icons.chat_bubble_outline),
            label: l10n.chat,
          ),
        ],
      ),
    );
  }
}
```

Import `TranslationScreen` and `AppLocalizations`. Follow existing RTL-ready patterns with `EdgeInsetsDirectional`.

`IndexedStack` keeps both screens alive so translation state isn't lost when switching tabs.

**2. Update app.dart if needed:**

The existing `app.dart` already imports `main_shell.dart` and uses `MainShell`. No changes needed unless the import path changes (it shouldn't — same file, same class name).

Add `LocaleNamesLocalizationsDelegate()` to the `localizationsDelegates` list in `app.dart` for `flutter_localized_locales` support:
```dart
localizationsDelegates: [
  ...AppLocalizations.localizationsDelegates,
  LocaleNamesLocalizationsDelegate(),
],
```

Import `package:flutter_localized_locales/flutter_localized_locales.dart`.

**3. Create typing indicator widget:**

Create `lib/features/translation/presentation/widgets/typing_indicator.dart`:

Build an iMessage-style animated pulsing dots indicator with:
- Three dots (Circles) arranged horizontally
- `AnimationController` for repeating animation
- Staggered `Interval` curves so dots pulse sequentially (not simultaneously)
- Color pulsing: `Color.lerp(dimColor, brightColor, animation.value)` using `sin(pi * value)` for smooth pulse
- `dimColor`: `AppColors.onSurfaceVariant.withOpacity(0.4)`
- `brightColor`: `AppColors.onSurfaceVariant`
- Dot size: 8dp diameter with 4dp spacing
- Wrapped in a container styled like a left-aligned assistant bubble (matches the translation bubble styling)

The widget should accept `bool isVisible` prop. When `isVisible` changes:
- true: start repeating animation
- false: stop animation (don't reverse — just stop and hide)

Use a `StatefulWidget` (not Consumer — this is a pure animation widget with no Riverpod dependency). The parent (`TranslationBubbleList`) passes `isVisible` based on `state.isTranslating && state.translatedText.isEmpty`.

Pattern from Flutter cookbook:
- Single `AnimationController` with `duration: Duration(milliseconds: 1200)` and `repeat()`
- Three `Tween<double>(begin: 0, end: 1)` with staggered `Interval`:
  - Dot 1: `Interval(0.0, 0.5, curve: Curves.easeInOut)`
  - Dot 2: `Interval(0.2, 0.7, curve: Curves.easeInOut)`
  - Dot 3: `Interval(0.4, 0.9, curve: Curves.easeInOut)`
- Each dot's opacity/scale: `sin(pi * animation.value)` for the pulse effect
  </action>
  <verify>
`/home/max/Android/flutter/bin/flutter analyze` passes. `grep -c 'NavigationBar' lib/widgets/main_shell.dart` returns at least 1. `grep -c 'TypingIndicator' lib/features/translation/presentation/widgets/typing_indicator.dart` returns at least 1. `grep -c 'LocaleNamesLocalizationsDelegate' lib/app.dart` returns at least 1.
  </verify>
  <done>
MainShell is a NavigationBar shell with Translate (index 0) and Chat placeholder (index 1) using IndexedStack. TypingIndicator widget animates three pulsing dots with staggered intervals. LocaleNamesLocalizationsDelegate is registered in app.dart.
  </done>
</task>

<task type="auto">
  <name>Task 2: Translation screen, bubble list, and input bar</name>
  <files>
    lib/features/translation/presentation/translation_screen.dart
    lib/features/translation/presentation/widgets/translation_bubble_list.dart
    lib/features/translation/presentation/widgets/translation_input_bar.dart
  </files>
  <action>
**1. Create TranslationScreen (`lib/features/translation/presentation/translation_screen.dart`):**

A `ConsumerStatefulWidget` (needs `TextEditingController` and `ScrollController`):

**AppBar:**
- Title area: Target language button showing the current `state.targetLanguage` name — tapping it will open the language picker in Plan 03. For now, show the language name as a `TextButton` with a dropdown arrow icon. Wire it as a placeholder that does nothing until Plan 03 adds the picker.
- Actions: New session button (`IconButton` with `Icons.note_add_outlined` or `Icons.add`) — calls `ref.read(translationNotifierProvider.notifier).startNewSession()`. Disabled when `state.isTranslating` is true.

**Body:** `Column` with:
1. **Context-full banner** (conditional): When `state.isContextFull`, show a subtle warning banner at the top using `AppColors.secondaryContainer` background with the `l10n.contextFullBanner` text and a "New session" action button.
2. **Bubble list** (Expanded): `TranslationBubbleList` widget (see below).
3. **Input bar** (bottom): `TranslationInputBar` widget (see below).

The Scaffold must use `resizeToAvoidBottomInset: true` (default) for correct keyboard avoidance. Wrap the input bar in `SafeArea(bottom: true)` for system navigation bar padding.

On first build, when `state.activeSession == null`, optionally query `ChatRepository` for the most recent `mode: 'translation'` session. For now, just show the empty state — session history loading is deferred to session management (Phase 7). The notifier creates a session on first `translate()` call.

**2. Create TranslationBubbleList (`lib/features/translation/presentation/widgets/translation_bubble_list.dart`):**

A `ConsumerWidget` that displays the chat-style bubble list:

**Message sourcing:**
- Watch `translationNotifierProvider` for `activeSession`.
- If `activeSession != null`, watch `sessionMessagesProvider(activeSession.id)` for persisted messages.
- During active streaming (`state.isTranslating`), the latest assistant message is not yet in DB — show it from `state.translatedText` with word-level batching.

**Word-level batching display:**
For the streaming assistant bubble (the one currently being generated):
- Detect if the text is space-delimited using a helper function `_isSpaceDelimited(String text)`:
  - Check if text contains CJK (U+4E00-U+9FFF), Japanese kana (U+3040-U+30FF), Thai (U+0E00-U+0E7F), Lao (U+0E80-U+0EFF), Khmer (U+1780-U+17FF), or Burmese (U+1000-U+109F) characters.
  - If any non-space-delimited characters found, display token-by-token (show full `state.translatedText`).
  - If space-delimited, display up to the last complete word boundary: `text.substring(0, text.lastIndexOf(RegExp(r'\s')) + 1)` during streaming. Show full text when `!state.isTranslating`.

**Bubble styling:**
- User bubbles (role: 'user'): Right-aligned, `AppColors.primaryContainer` background, white text, rounded corners (16dp radius, less on the right side to create the "tail" effect — `BorderRadius.only(topLeft: 16, topRight: 16, bottomLeft: 16, bottomRight: 4)`).
- Assistant bubbles (role: 'assistant'): Left-aligned, `AppColors.surfaceContainer` background, white text, rounded corners (mirror — `bottomLeft: 4`). Small target language tag below the text in `AppColors.onSurfaceVariant` using `bodySmall` text style.
- All padding: `EdgeInsetsDirectional` (RTL-ready).
- Bubble max width: 80% of screen width.
- Spacing between bubbles: 8dp vertical.

**Empty state:**
When there are no messages and no active session, show centered `l10n.translationEmptyState` text in `AppColors.onSurfaceVariant` color.

**Auto-scroll:**
Use a `ScrollController`. After messages change (new message added or streaming text updates), call `_scrollToBottom()` which uses `WidgetsBinding.instance.addPostFrameCallback` to scroll to `maxScrollExtent` with a 300ms `easeOut` animation. Only auto-scroll if the user is already near the bottom (within 100 pixels of maxScrollExtent) — don't force scroll if user has scrolled up to read earlier messages.

**Typing indicator integration:**
After the last user bubble and before the streaming assistant bubble, show the `TypingIndicator` when `state.isTranslating && state.translatedText.isEmpty`.

**ListView construction:**
Use `ListView.builder` (not `ListView(children: [...])`) for performance. The item count is: `DB messages count + (isTranslating && translatedText.isNotEmpty ? 1 : 0) + (showTypingIndicator ? 1 : 0)`. Map each index to the correct widget (DB message bubble, typing indicator, or streaming bubble).

**3. Create TranslationInputBar (`lib/features/translation/presentation/widgets/translation_input_bar.dart`):**

A `ConsumerStatefulWidget` (owns `TextEditingController`):

**TextField:**
- `minLines: 1`, `maxLines: 6` — grows as user types paragraphs, scrolls after 6 lines.
- `keyboardType: TextInputType.multiline`
- `textInputAction: TextInputAction.newline` — Enter inserts newline (per locked decision: send button only, not enter-to-send).
- `hintText: l10n.translationInputHint`
- Disable when `!state.isModelReady`.
- Use app theme's `inputDecorationTheme` styling.

**Soft character limit:**
- Show a character counter below the input when text length > 400 characters.
- At > 500 characters, change counter color to `AppColors.error` and show `l10n.characterLimitWarning`.
- This is a warning only — don't block sending.

**Send/Stop button:**
- Show to the right of the text field.
- When `state.isTranslating`: Show stop icon (`Icons.stop_circle`), tapping calls `stopTranslation()`.
- When not translating: Show send icon (`Icons.send`), tapping calls `translate(text)` and clears the input.
- Use `AnimatedSwitcher(duration: Duration(milliseconds: 200))` for smooth icon transition.
- Disable send when input is empty or model not ready (`state.isModelReady`).
- Colors: Active = `AppColors.secondary` (lime), Disabled = `AppColors.onSurfaceVariant`.

**Layout:**
```dart
SafeArea(
  bottom: true,
  child: Padding(
    padding: EdgeInsetsDirectional.fromSTEB(12, 8, 12, 8),
    child: Row(
      crossAxisAlignment: CrossAxisAlignment.end,  // Align to bottom for multi-line
      children: [
        Expanded(child: TextField(...)),
        SizedBox(width: 8),
        IconButton(onPressed: ..., icon: AnimatedSwitcher(...)),
      ],
    ),
  ),
)
```
  </action>
  <verify>
`/home/max/Android/flutter/bin/flutter analyze` passes with no errors. All 3 new files compile. `grep -c 'translationNotifierProvider' lib/features/translation/presentation/translation_screen.dart` returns at least 1. `grep -c 'sessionMessagesProvider' lib/features/translation/presentation/widgets/translation_bubble_list.dart` returns at least 1. `grep -c 'translate\|stopTranslation' lib/features/translation/presentation/widgets/translation_input_bar.dart` returns at least 2.
  </verify>
  <done>
TranslationScreen is a full scaffold with AppBar (target language button placeholder, new session button), context-full banner, bubble list, and input bar. Bubble list shows DB messages + streaming message with word-level batching. Typing indicator shows while waiting for first token. Input bar has multi-line expandable TextField with send/stop toggle and soft character limit. Auto-scroll works with post-frame callback and respects user scroll position.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes across all new and modified files
2. MainShell shows NavigationBar with Translate and Chat tabs
3. TranslationScreen renders with AppBar, bubble list, and input bar
4. Typing text and tapping Send calls translationNotifierProvider.notifier.translate()
5. Send button transforms to stop icon during state.isTranslating
6. Typing indicator appears when isTranslating && translatedText.isEmpty
7. User bubbles are right-aligned, assistant bubbles are left-aligned with language tag
8. Auto-scroll fires after new messages without overriding user scroll-up
9. Empty state shows centered prompt text
10. New session button calls startNewSession()
</verification>

<success_criteria>
- MainShell replaced with NavigationBar + IndexedStack (Translate tab active, Chat placeholder)
- TranslationScreen is a working chat-style translation interface
- Bubble list sources messages from DB (via sessionMessagesProvider) and shows streaming text
- Word-level batching works for space-delimited scripts, token-by-token for CJK/Thai
- Typing indicator animates three pulsing dots with staggered intervals
- Input bar is multi-line expandable (1-6 lines) with send/stop toggle
- Soft character limit warning appears at 400+ characters
- Auto-scroll and keyboard avoidance work correctly
- All widgets use EdgeInsetsDirectional and AppLocalizations
</success_criteria>

<output>
After completion, create `.planning/phases/05-translation-ui/05-02-SUMMARY.md`
</output>
