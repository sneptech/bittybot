---
phase: 05-translation-ui
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - pubspec.yaml
  - lib/features/translation/domain/supported_language.dart
  - lib/features/translation/data/language_data.dart
  - lib/features/translation/application/translation_notifier.dart
  - lib/features/translation/application/translation_notifier.g.dart
  - lib/features/translation/application/session_messages_provider.dart
  - lib/features/translation/application/session_messages_provider.g.dart
  - lib/features/settings/application/settings_provider.dart
  - lib/features/settings/application/settings_provider.g.dart
  - lib/core/l10n/app_en.arb
  - lib/core/l10n/app_es.arb
  - lib/core/l10n/app_fr.arb
  - lib/core/l10n/app_ar.arb
  - lib/core/l10n/app_zh.arb
  - lib/core/l10n/app_ja.arb
  - lib/core/l10n/app_pt.arb
  - lib/core/l10n/app_de.arb
  - lib/core/l10n/app_ko.arb
  - lib/core/l10n/app_hi.arb
autonomous: true
requirements:
  - TRNS-02
  - TRNS-03
  - TRNS-05

must_haves:
  truths:
    - "All 66 Tiny Aya supported languages are represented as SupportedLanguage entries with English name, ISO language code, and primary country code"
    - "Target language selection is persisted in SharedPreferences and survives app restart"
    - "TranslationNotifier exposes a public startNewSession() method for the UI new-session button"
    - "A StreamProvider.family watches session messages reactively from the DB"
  artifacts:
    - path: "lib/features/translation/domain/supported_language.dart"
      provides: "SupportedLanguage value object with englishName, code, primaryCountryCode"
      contains: "class SupportedLanguage"
    - path: "lib/features/translation/data/language_data.dart"
      provides: "Full list of 66 languages with country code mappings and popular languages list"
      contains: "kSupportedLanguages"
    - path: "lib/features/translation/application/session_messages_provider.dart"
      provides: "Riverpod StreamProvider.family for reactive message watching"
      contains: "sessionMessages"
    - path: "lib/features/settings/application/settings_provider.dart"
      provides: "targetLanguage field on AppSettings with SharedPreferences persistence"
      contains: "targetLanguage"
  key_links:
    - from: "lib/features/settings/application/settings_provider.dart"
      to: "SharedPreferences"
      via: "setTargetLanguage() persists to SharedPreferencesWithCache"
      pattern: "_kTargetLanguageKey"
    - from: "lib/features/translation/application/session_messages_provider.dart"
      to: "lib/features/chat/data/chat_repository.dart"
      via: "chatRepositoryProvider.watchMessagesForSession(sessionId)"
      pattern: "watchMessagesForSession"
    - from: "lib/features/translation/application/translation_notifier.dart"
      to: "lib/features/settings/application/settings_provider.dart"
      via: "reads targetLanguage from settings on build()"
      pattern: "settingsProvider"
---

<objective>
Create the foundation layer for Phase 5: language data model (66 languages with country code mappings), target language persistence via settings provider, TranslationNotifier extensions (startNewSession, settings integration), session messages stream provider, and translation UI l10n strings.

Purpose: All subsequent Phase 5 plans depend on these data structures, providers, and l10n strings. Building them first in isolation avoids file conflicts in later plans.

Output: SupportedLanguage domain type, complete language data with country mappings, extended AppSettings with target language persistence, TranslationNotifier with startNewSession() and settings-aware default language, session messages stream provider, and l10n strings for all 10 supported app languages.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-translation-ui/05-CONTEXT.md
@.planning/phases/05-translation-ui/05-RESEARCH.md
@.planning/phases/04-core-inference-architecture/04-05-SUMMARY.md

# Existing code references
@lib/features/translation/application/translation_notifier.dart
@lib/features/settings/application/settings_provider.dart
@lib/features/chat/data/chat_repository.dart
@lib/features/chat/domain/chat_session.dart
@lib/features/chat/domain/chat_message.dart
@lib/features/chat/application/chat_repository_provider.dart
@lib/core/l10n/app_en.arb
@pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Language data model, country mappings, and new dependencies</name>
  <files>
    pubspec.yaml
    lib/features/translation/domain/supported_language.dart
    lib/features/translation/data/language_data.dart
  </files>
  <action>
**1. Add new dependencies to pubspec.yaml:**

Under the `# Phase 3: App foundation` comment block (or add a new `# Phase 5: Translation UI` comment), add:
```yaml
  # Phase 5: Translation UI
  country_flags: ^4.1.2
  flutter_localized_locales: ^2.0.5
```

Run `/home/max/Android/flutter/bin/flutter pub get` to resolve.

**2. Create `lib/features/translation/domain/supported_language.dart`:**

Immutable value object:
```dart
@immutable
class SupportedLanguage {
  /// English name of the language (e.g., 'Spanish').
  /// Used as the key for TranslationNotifier.setTargetLanguage().
  final String englishName;

  /// ISO 639-1 language code (e.g., 'es').
  /// Used by flutter_localized_locales for LocaleNames.of(context).nameOf(code).
  final String code;

  /// ISO 3166-1 alpha-2 country code for the flag icon (e.g., 'ES').
  /// Used by country_flags CountryFlag.fromCountryCode().
  final String primaryCountryCode;

  const SupportedLanguage({
    required this.englishName,
    required this.code,
    required this.primaryCountryCode,
  });
}
```

Use `@immutable` from `package:flutter/foundation.dart`. Follow existing pattern (ChatSession, ChatMessage).

**3. Create `lib/features/translation/data/language_data.dart`:**

This is the canonical language list for the language picker. Contains:

- `const List<SupportedLanguage> kSupportedLanguages` — all 66 languages from the research file with correct ISO codes and primary country codes. The full list from research:

European (31): English/en/US, Dutch/nl/NL, French/fr/FR, Italian/it/IT, Portuguese/pt/PT, Romanian/ro/RO, Spanish/es/ES, Czech/cs/CZ, Polish/pl/PL, Ukrainian/uk/UA, Russian/ru/RU, Greek/el/GR, German/de/DE, Danish/da/DK, Swedish/sv/SE, Norwegian/no/NO, Catalan/ca/ES, Galician/gl/ES, Welsh/cy/GB, Irish/ga/IE, Basque/eu/ES, Croatian/hr/HR, Latvian/lv/LV, Lithuanian/lt/LT, Slovak/sk/SK, Slovenian/sl/SI, Estonian/et/EE, Finnish/fi/FI, Hungarian/hu/HU, Serbian/sr/RS, Bulgarian/bg/BG

Middle Eastern & Central Asian (6): Arabic/ar/SA, Persian/fa/IR, Urdu/ur/PK, Turkish/tr/TR, Maltese/mt/MT, Hebrew/he/IL

South Asian (8): Hindi/hi/IN, Marathi/mr/IN, Bengali/bn/BD, Gujarati/gu/IN, Punjabi/pa/IN, Tamil/ta/IN, Telugu/te/IN, Nepali/ne/NP

Southeast Asian (7): Tagalog/tl/PH, Malay/ms/MY, Indonesian/id/ID, Javanese/jv/ID, Khmer/km/KH, Thai/th/TH, Lao/lo/LA

East Asian (4): Chinese/zh/CN, Burmese/my/MM, Japanese/ja/JP, Korean/ko/KR

African (10): Amharic/am/ET, Hausa/ha/NG, Igbo/ig/NG, Malagasy/mg/MG, Shona/sn/ZW, Swahili/sw/TZ, Wolof/wo/SN, Xhosa/xh/ZA, Yoruba/yo/NG, Zulu/zu/ZA

Sort the list alphabetically by `englishName` for deterministic order.

- `const List<String> kPopularLanguages` — top 10 by global usage: `['Spanish', 'French', 'Arabic', 'Chinese', 'Hindi', 'Portuguese', 'Russian', 'Japanese', 'German', 'Korean']`. Used by the language picker to pin at top.

- `const Map<String, Map<String, String>> kLanguageCountryVariants` — maps language codes to device locale country codes that should override the primary. Example:
```dart
const kLanguageCountryVariants = {
  'es': {'MX': 'MX', 'CO': 'CO', 'AR': 'AR', 'CL': 'CL', 'PE': 'PE', 'VE': 'VE'},
  'pt': {'BR': 'BR'},
  'en': {'US': 'US', 'AU': 'AU', 'CA': 'CA', 'NZ': 'NZ'},
  'fr': {'CA': 'CA', 'BE': 'BE', 'CH': 'CH'},
  'zh': {'TW': 'TW', 'HK': 'HK'},
  'ar': {'EG': 'EG', 'MA': 'MA', 'DZ': 'DZ', 'TN': 'TN', 'IQ': 'IQ', 'JO': 'JO', 'LB': 'LB'},
  'ta': {'LK': 'LK'},
  'bn': {'IN': 'IN'},
  'sw': {'KE': 'KE'},
};
```

- A helper function `String resolveCountryCode(SupportedLanguage lang, Locale deviceLocale)` that checks if the device locale's country code is in the variants map for the language, returning that country code if found, otherwise the language's `primaryCountryCode`.
  </action>
  <verify>
`/home/max/Android/flutter/bin/flutter pub get` succeeds. `/home/max/Android/flutter/bin/flutter analyze` shows no errors in the new files. The kSupportedLanguages list has exactly 66 entries.
  </verify>
  <done>
SupportedLanguage value object exists. Language data file has 66 languages sorted alphabetically with correct ISO codes and country codes. Popular languages list has 10 entries. Device locale country code resolver works for language variants. New packages (country_flags, flutter_localized_locales) are resolved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Target language persistence, TranslationNotifier extensions, session messages provider, and l10n strings</name>
  <files>
    lib/features/settings/application/settings_provider.dart
    lib/features/settings/application/settings_provider.g.dart
    lib/features/translation/application/translation_notifier.dart
    lib/features/translation/application/translation_notifier.g.dart
    lib/features/translation/application/session_messages_provider.dart
    lib/features/translation/application/session_messages_provider.g.dart
    lib/core/l10n/app_en.arb
    lib/core/l10n/app_es.arb
    lib/core/l10n/app_fr.arb
    lib/core/l10n/app_ar.arb
    lib/core/l10n/app_zh.arb
    lib/core/l10n/app_ja.arb
    lib/core/l10n/app_pt.arb
    lib/core/l10n/app_de.arb
    lib/core/l10n/app_ko.arb
    lib/core/l10n/app_hi.arb
  </files>
  <action>
**1. Extend AppSettings and settingsProvider with targetLanguage (TRNS-05):**

In `lib/features/settings/application/settings_provider.dart`:

- Add `final String targetLanguage;` field to `AppSettings` with default `'Spanish'`.
- Update `const AppSettings` constructor: `this.targetLanguage = 'Spanish'`.
- Update `copyWith` to accept `String? targetLanguage` and pass through.
- In `Settings` notifier class, add `static const _kTargetLanguageKey = 'target_language';`
- In `build()`, read: `final targetLang = _prefs.getString(_kTargetLanguageKey);` and include in returned AppSettings: `targetLanguage: targetLang ?? 'Spanish'`.
- Add `setTargetLanguage(String language)` method:
  ```dart
  Future<void> setTargetLanguage(String language) async {
    await _prefs.setString(_kTargetLanguageKey, language);
    final current = state.value ?? const AppSettings();
    state = AsyncValue.data(current.copyWith(targetLanguage: language));
  }
  ```

- Also add `recentTargetLanguages` (List<String>, max 3) for rolling history:
  - Field: `final List<String> recentTargetLanguages;` with default `const []`.
  - In `build()`: read from `_prefs.getStringList(_kRecentTargetLanguagesKey) ?? []`.
  - Static key: `static const _kRecentTargetLanguagesKey = 'recent_target_languages';`
  - Update `setTargetLanguage` to also update the recent list: prepend the new language, remove duplicates, cap at 3, persist.

Run `/home/max/Android/flutter/bin/flutter pub run build_runner build --delete-conflicting-outputs` to regenerate the .g.dart file.

**2. Extend TranslationNotifier with startNewSession() and settings integration:**

In `lib/features/translation/application/translation_notifier.dart`:

- Add import: `import '../../settings/application/settings_provider.dart';`
- In `build()`, read the persisted target language from settings and use it as default:
  ```dart
  final settingsAsync = ref.watch(settingsProvider);
  final targetLanguage = settingsAsync.value?.targetLanguage ?? 'Spanish';
  return TranslationState(isModelReady: isModelReady, targetLanguage: targetLanguage);
  ```

- Add a public `startNewSession()` method (per research Pitfall 6):
  ```dart
  /// Starts a fresh translation session.
  ///
  /// Saves the current session (already persisted in DB), clears KV cache
  /// and in-memory state. The next translate() call creates a new DB session.
  /// Called by the "new session" (+) button in the translation screen top bar.
  Future<void> startNewSession() async {
    _pendingQueue.clear();
    final inferenceRepo = ref.read(inferenceRepositoryProvider);
    inferenceRepo.clearContext();
    state = state.copyWith(
      sourceText: '',
      translatedText: '',
      isContextFull: false,
      turnCount: 0,
      clearActiveSession: true,
      clearActiveRequestId: true,
    );
  }
  ```

- Update `setTargetLanguage()` to also persist to settings:
  ```dart
  Future<void> setTargetLanguage(String language) async {
    if (language == state.targetLanguage) return;
    state = state.copyWith(targetLanguage: language);
    // Persist to settings for TRNS-05 (app restart persistence).
    ref.read(settingsProvider.notifier).setTargetLanguage(language);
    await _resetSession();
  }
  ```

Run `build_runner build` to regenerate .g.dart.

**3. Create session messages stream provider:**

Create `lib/features/translation/application/session_messages_provider.dart`:
```dart
import 'package:riverpod_annotation/riverpod_annotation.dart';
import '../../chat/application/chat_repository_provider.dart';
import '../../chat/domain/chat_message.dart';

part 'session_messages_provider.g.dart';

/// Reactive stream of messages for a given session.
///
/// Used by TranslationScreen to display the bubble list. Auto-updates
/// when new messages are inserted during translation streaming.
@riverpod
Stream<List<ChatMessage>> sessionMessages(Ref ref, int sessionId) {
  final chatRepo = ref.watch(chatRepositoryProvider);
  return chatRepo.watchMessagesForSession(sessionId);
}
```

Run `build_runner build` to generate the .g.dart file.

**4. Add translation UI l10n strings to all 10 ARB files:**

Add these keys to `app_en.arb` (with @ metadata):
```json
"translate": "Translate",
"chat": "Chat",
"translationInputHint": "Type something to translate",
"translationEmptyState": "Type something to translate",
"newSession": "New session",
"targetLanguage": "Target language",
"searchLanguages": "Search languages",
"popularLanguages": "Popular",
"recentLanguages": "Recent",
"copied": "Copied",
"copyTranslation": "Copy translation",
"contextFullBanner": "Session is getting long. Start a new session for best results.",
"characterLimitWarning": "Approaching character limit"
```

Add the same keys (translated) to all 9 other ARB files. Keep translations concise and natural for each language. These are short UI labels so translations are straightforward. Do not add @ metadata to non-English ARBs (existing pattern).

Run `/home/max/Android/flutter/bin/flutter gen-l10n` to regenerate AppLocalizations.
  </action>
  <verify>
`/home/max/Android/flutter/bin/flutter analyze` passes with no errors. `/home/max/Android/flutter/bin/flutter gen-l10n` succeeds. `grep -c 'targetLanguage' lib/features/settings/application/settings_provider.dart` returns at least 3 (field, constructor, setter). `grep -c 'startNewSession' lib/features/translation/application/translation_notifier.dart` returns at least 1.
  </verify>
  <done>
AppSettings has targetLanguage field with SharedPreferences persistence. TranslationNotifier has public startNewSession() method and persists language changes to settings. Session messages stream provider exists and watches from ChatRepository. All 10 ARB files have the 13 new translation UI keys. AppLocalizations regenerated.
  </done>
</task>

</tasks>

<verification>
1. `flutter pub get` succeeds with country_flags and flutter_localized_locales resolved
2. `flutter analyze` reports no errors across all new and modified files
3. `flutter gen-l10n` succeeds and AppLocalizations includes all new keys
4. kSupportedLanguages contains exactly 66 SupportedLanguage entries
5. AppSettings.targetLanguage defaults to 'Spanish' and persists to SharedPreferences
6. TranslationNotifier.startNewSession() is public and callable
7. sessionMessagesProvider is generated and callable with a session ID
</verification>

<success_criteria>
- New dependencies (country_flags ^4.1.2, flutter_localized_locales ^2.0.5) are in pubspec.yaml and resolved
- SupportedLanguage value object exists with englishName, code, primaryCountryCode
- 66 languages are listed with correct ISO codes and country mappings
- Popular languages list (10 entries) and country variant resolver exist
- AppSettings extended with targetLanguage and recentTargetLanguages
- TranslationNotifier reads persisted target language on build() and has startNewSession()
- Session messages stream provider works for reactive message watching
- All 10 ARB files have 13 new translation UI strings
</success_criteria>

<output>
After completion, create `.planning/phases/05-translation-ui/05-01-SUMMARY.md`
</output>
