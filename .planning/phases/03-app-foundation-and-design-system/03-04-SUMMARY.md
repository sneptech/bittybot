---
phase: 03-app-foundation-and-design-system
plan: 04
subsystem: ui
tags: [flutter, riverpod, shared_preferences, settings, error_handling, l10n, tone]

requires:
  - phase: "03-02"
    provides: "Theme system and AppColors — no direct dependency, but confirms project compiles"
  - phase: "03-03"
    provides: "AppLocalizations with 22-key dual-tone error strings for all 10 locales"

provides:
  - "ErrorTone enum (friendly/direct) in lib/core/error/error_tone.dart"
  - "AppSettings immutable value class with localeOverride and errorTone fields"
  - "Settings AsyncNotifier (settingsProvider) persisting locale and error tone via SharedPreferencesWithCache"
  - "AppError enum (modelNotLoaded, inputTooLong, inferenceFailed, generic)"
  - "resolveErrorMessage function — exhaustive (AppError, ErrorTone) switch returning localized strings"

affects: [03-05, phase-04-core-inference-arch, phase-05-translation-ui, phase-06-chat-ui]

tech-stack:
  added: []
  patterns:
    - "Settings persistence via SharedPreferencesWithCache (not deprecated SharedPreferences.getInstance())"
    - "Riverpod keepAlive: true for settings — never disposed during app lifetime"
    - "Dart 3 record pattern switch (AppError, ErrorTone) for exhaustive tone-aware error resolution"
    - "setLocale(null) removes key and reverts to device locale; non-null Locale overrides device default"
    - "AsyncValue.data(...) state update triggers widget rebuilds after each mutation"

key-files:
  created:
    - lib/core/error/error_tone.dart (ErrorTone enum — friendly/direct)
    - lib/features/settings/application/settings_provider.dart (AppSettings + Settings AsyncNotifier)
    - lib/features/settings/application/settings_provider.g.dart (generated by riverpod_generator 4.0.0+1)
    - lib/core/error/error_messages.dart (AppError enum + resolveErrorMessage function)
  modified: []

key-decisions:
  - "Used AsyncValue.value (not .valueOrNull) for Riverpod 3.1.0 — valueOrNull does not exist on AsyncValue in this version"
  - "resolveErrorMessage uses Dart 3 record pattern switch: (AppError, ErrorTone) — compiler catches missing combinations at analysis time"
  - "ErrorTone has exactly two values (friendly/direct) matching the dual-tone ARB pattern established in Plan 03"

patterns-established:
  - "Error strings always flow through resolveErrorMessage — no direct AppLocalizations access for error messages in feature code"
  - "Settings mutations update SharedPreferences then update state synchronously with AsyncValue.data to avoid re-loading from disk"

requirements-completed: [UIUX-06]

duration: 4min
completed: 2026-02-18
---

# Phase 3 Plan 04: Settings Persistence and Error Message Resolver Summary

**Riverpod 3.x Settings AsyncNotifier persisting locale override and error tone via SharedPreferencesWithCache, plus an exhaustive Dart 3 pattern-matched error message resolver returning tone-appropriate localized strings for all 4 error scenarios**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-18T19:10:45Z
- **Completed:** 2026-02-18T19:14:57Z
- **Tasks:** 2
- **Files modified:** 4 created

## Accomplishments

- `ErrorTone` enum with two values (friendly, direct) feeds both the settings provider and error resolver
- `AppSettings` immutable class with `localeOverride` (nullable — null = follow device) and `errorTone` fields, with `copyWith` supporting nullable override via `Locale? Function()?`
- `Settings` AsyncNotifier (generated as `settingsProvider`) reads from SharedPreferencesWithCache on init, persists on every mutation, uses `keepAlive: true`
- `resolveErrorMessage` exhaustively covers all 8 `(AppError, ErrorTone)` combinations using Dart 3 record pattern matching — compiler-enforced completeness
- `flutter analyze` passes with 0 errors on all new files; sole pre-existing warning is in Drift-generated code (out of scope)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create SettingsProvider with SharedPreferencesWithCache** - `b657b6a` (feat)
2. **Task 2: Create error message resolver with tone switching** - `423e0a1` (feat)

**Plan metadata:** (docs commit added after summary)

## Files Created/Modified

- `lib/core/error/error_tone.dart` — ErrorTone enum (friendly, direct) with docstring explaining tone intent
- `lib/features/settings/application/settings_provider.dart` — AppSettings value class + Settings AsyncNotifier with SharedPreferencesWithCache persistence
- `lib/features/settings/application/settings_provider.g.dart` — Generated by riverpod_generator; exports `settingsProvider` as a `SettingsProvider` (extends `$AsyncNotifierProvider`)
- `lib/core/error/error_messages.dart` — AppError enum + resolveErrorMessage function with Dart 3 exhaustive switch; documents recommended presentation per error type

## Decisions Made

1. **AsyncValue.value not .valueOrNull**: Riverpod 3.1.0 does not expose `valueOrNull` on `AsyncValue` — that getter exists on `ProviderListenable` not `AsyncValue`. Used `.value` (which returns `T?`) instead. [Rule 1 - Bug, auto-fixed during verify step]

2. **Dart 3 record pattern switch**: `resolveErrorMessage` uses `switch ((error, tone)) { ... }` — a 2-tuple record pattern. This forces exhaustiveness at compile time; adding a new `AppError` variant without adding both tone cases causes an analyzer error.

3. **Locale persistence as languageCode string**: Only the `languageCode` is stored (e.g., `'ar'`), not the full BCP 47 tag. Sufficient for the 10 supported locales which are all identified by language code alone.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed .valueOrNull usage — not available on AsyncValue in Riverpod 3.1.0**
- **Found during:** Task 1 verify step (flutter analyze)
- **Issue:** `state.valueOrNull` caused `undefined_getter` error — `valueOrNull` does not exist on `AsyncValue<T>` in riverpod 3.1.0
- **Fix:** Replaced with `state.value` which returns `T?` and is the correct API for reading the current data value
- **Files modified:** `lib/features/settings/application/settings_provider.dart`
- **Verification:** `flutter analyze lib/features/settings/ lib/core/error/error_tone.dart` — 0 issues
- **Committed in:** `b657b6a` (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 - Bug)
**Impact on plan:** Single-line fix required to match actual Riverpod 3.1.0 API. No scope creep.

## Issues Encountered

- `valueOrNull` does not exist on `AsyncValue` in riverpod 3.1.0. The getter exists on `ProviderListenable` (the ref-side API) but not on `AsyncValue` itself. Fixed by using `.value` which is the correct nullable accessor.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- `settingsProvider` is ready for Plan 05 (`main.dart`): wrap `MaterialApp` locale with `ref.watch(settingsProvider)` and pass `localeOverride` to `MaterialApp.locale`
- `resolveErrorMessage` is ready for any feature that shows errors: import `AppError`, `ErrorTone`, and `resolveErrorMessage`, then call with current `AppLocalizations` and settings tone
- Plan 05 can wire `settingsProvider` to `MaterialApp.locale` to enable the in-app language override
- Phase 4 (Core Inference Arch) and Phase 5 (Translation UI) can use `resolveErrorMessage` for all inference error displays

---
*Phase: 03-app-foundation-and-design-system*
*Completed: 2026-02-18*

## Self-Check: PASSED

All claimed files verified present on disk. Both task commits confirmed in git log.
- lib/core/error/error_tone.dart: FOUND
- lib/features/settings/application/settings_provider.dart: FOUND
- lib/features/settings/application/settings_provider.g.dart: FOUND
- lib/core/error/error_messages.dart: FOUND
- b657b6a (Task 1): FOUND
- 423e0a1 (Task 2): FOUND
