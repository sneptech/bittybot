---
phase: 03-app-foundation-and-design-system
plan: 05
subsystem: ui
tags: [flutter, riverpod, l10n, theme, app-entry-point, startup-gate, error-screen, rtl, unit-tests, wcag]

requires:
  - phase: "03-02"
    provides: "buildDarkTheme(), AppColors, AppTextTheme — used by app.dart and test assertions"
  - phase: "03-03"
    provides: "AppLocalizations with 22 type-safe strings — used in all widgets and error message tests"
  - phase: "03-04"
    provides: "settingsProvider (locale override, error tone) and resolveErrorMessage — wired into BittyBotApp and AppStartupErrorScreen"

provides:
  - "lib/main.dart: ProviderScope root with GoogleFonts offline config"
  - "lib/app.dart: BittyBotApp ConsumerWidget with dark theme, forced dark mode, locale resolution, and AppStartupWidget home"
  - "lib/widgets/app_startup_widget.dart: appStartupProvider (keepAlive, Future<void>) + AppStartupWidget async gate"
  - "lib/widgets/model_loading_screen.dart: full-screen loading with lime CircularProgressIndicator and l10n strings"
  - "lib/widgets/app_startup_error_screen.dart: error screen with tone-aware resolveErrorMessage and 48dp retry button"
  - "lib/widgets/main_shell.dart: placeholder Scaffold with localized AppBar title"
  - "test/core/theme/app_theme_test.dart: 10 tests verifying dark brightness, WCAG contrast, 16sp body, padded tap targets"
  - "test/core/error/error_messages_test.dart: 9 tests verifying all 8 AppError x ErrorTone combinations produce non-empty strings"

affects: [phase-04-core-inference-arch, phase-05-translation-ui, phase-06-chat-ui]

tech-stack:
  added: []
  patterns:
    - "ProviderScope at root — Riverpod requires this to wrap the entire app"
    - "GoogleFonts.config.allowRuntimeFetching = false in main() — offline-first: fonts must be bundled"
    - "AppStartupWidget pattern: single async gate provider (appStartupProvider) controls loading/error/main routing"
    - "ref.invalidate(appStartupProvider) restarts the entire startup sequence on retry"
    - "localeResolutionCallback: exact match → language-code match → English fallback (documented in app.dart)"
    - "TestWidgetsFlutterBinding.ensureInitialized() required in setUpAll for google_fonts tests"
    - "EdgeInsetsDirectional throughout widgets (not EdgeInsets) — RTL-ready from the start"

key-files:
  created:
    - lib/app.dart (BittyBotApp ConsumerWidget — MaterialApp with theme, locale, startup gate)
    - lib/widgets/app_startup_widget.dart (appStartupProvider + AppStartupWidget)
    - lib/widgets/app_startup_widget.g.dart (generated by riverpod_generator)
    - lib/widgets/model_loading_screen.dart (loading screen)
    - lib/widgets/app_startup_error_screen.dart (error screen with retry)
    - lib/widgets/main_shell.dart (placeholder shell)
    - test/core/theme/app_theme_test.dart (10 theme property tests)
    - test/core/error/error_messages_test.dart (9 error resolver tests)
  modified:
    - lib/main.dart (replaced minimal placeholder with production entry point)

key-decisions:
  - "TestWidgetsFlutterBinding.ensureInitialized() required in theme test setUpAll — google_fonts reads asset bundle via ServicesBinding which needs initialization before non-widget tests call buildDarkTheme()"
  - "appStartupProvider is a simple @Riverpod(keepAlive: true) Future<void> function-provider, not a class notifier — startup is fire-and-forget, no mutation needed"
  - "AppStartupErrorScreen uses resolveErrorMessage(l10n, AppError.modelNotLoaded, tone) — most common startup failure is settings not loading; friendly tone fallback used when settings are unavailable"

patterns-established:
  - "All app startup gating flows through appStartupProvider — Phase 4 model readiness extends this provider, not a separate gate"
  - "Widget padding: always EdgeInsetsDirectional — never EdgeInsets — established in all 4 new widget files"

requirements-completed: [UIUX-01, UIUX-02, UIUX-03, UIUX-04, UIUX-05, UIUX-06]

duration: 6min
completed: 2026-02-18
---

# Phase 3 Plan 05: App Wiring Summary

**ProviderScope root with BittyBotApp MaterialApp (dark theme, locale resolution, 10 languages), AppStartupWidget async gate showing loading/error/main shell, plus 19 unit tests verifying WCAG contrast, 16sp body text, and all 8 error tone combinations**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-18T19:18:00Z
- **Completed:** 2026-02-18T19:24:18Z
- **Tasks:** 2 of 3 auto tasks complete (Task 3 is human verification checkpoint)
- **Files modified:** 9 created, 1 modified

## Accomplishments

- `lib/main.dart` wired with `ProviderScope`, `GoogleFonts.config.allowRuntimeFetching = false` — offline-first enforced at entry point
- `BittyBotApp` `ConsumerWidget` reads `settingsProvider` for locale override, applies `buildDarkTheme()`, forces dark mode, sets full `AppLocalizations` delegation with custom `localeResolutionCallback` (exact → language code → English fallback)
- `appStartupProvider` (keepAlive, `Future<void>`) awaits `settingsProvider.future` — Phase 4 extends by adding `modelReadyProvider`
- `AppStartupWidget` routes to `ModelLoadingScreen`, `AppStartupErrorScreen`, or `onLoaded` callback based on `appStartupProvider` state
- `ModelLoadingScreen` uses lime `CircularProgressIndicator`, localized strings, all padding via `EdgeInsetsDirectional`
- `AppStartupErrorScreen` uses `resolveErrorMessage` for tone-appropriate error text, 48dp retry button, `ref.invalidate(appStartupProvider)` on retry
- `MainShell` placeholder scaffold with `l10n.appName` in AppBar — `EdgeInsetsDirectional` for body padding
- 10 theme tests pass: dark brightness, near-black surface, forest green primary, white `onSurface`, WCAG AA (4.5:1) white-on-primary (7.87:1 actual) and white-on-surface (18.03:1 actual), 16sp `bodyMedium`, 18sp `bodyLarge`, padded tap targets
- 9 error resolver tests pass: string content checks for warmup/not-loaded messages, all 8 `AppError x ErrorTone` combinations non-empty
- Debug APK builds successfully

## Task Commits

Each task was committed atomically:

1. **Task 1: Create app entry point, MaterialApp shell, and startup widget** - `0ca24fb` (feat)
2. **Task 2: Write unit tests for theme properties and error messages** - `b73f2cc` (test)

**Plan metadata:** (docs commit added after summary)

## Files Created/Modified

- `lib/main.dart` — Production entry point: GoogleFonts offline mode, ProviderScope root
- `lib/app.dart` — BittyBotApp: dark theme, forced dark mode, 10-language localization, locale resolution, AppStartupWidget home
- `lib/widgets/app_startup_widget.dart` — appStartupProvider + AppStartupWidget async gate
- `lib/widgets/app_startup_widget.g.dart` — Generated by riverpod_generator 4.0.0
- `lib/widgets/model_loading_screen.dart` — Full-screen loading with lime progress indicator and l10n strings
- `lib/widgets/app_startup_error_screen.dart` — Error screen with tone-aware message and 48dp retry button
- `lib/widgets/main_shell.dart` — Placeholder scaffold with localized AppBar title, EdgeInsetsDirectional padding
- `test/core/theme/app_theme_test.dart` — 10 theme contract tests (ColorScheme, WCAG contrast, typography, accessibility)
- `test/core/error/error_messages_test.dart` — 9 error resolver tests (all 8 AppError x ErrorTone combinations)

## Decisions Made

1. **TestWidgetsFlutterBinding.ensureInitialized() in theme test setUpAll**: `buildDarkTheme()` calls `GoogleFonts.latoTextTheme()` which needs the `ServicesBinding` to be initialized to load font assets. Without `TestWidgetsFlutterBinding.ensureInitialized()`, all theme tests fail with "Binding has not yet been initialized." Non-widget unit tests need this explicit initialization. [Rule 1 - Bug, auto-fixed]

2. **appStartupProvider as function provider (not class notifier)**: The startup gate is fire-and-forget — it runs once, awaits dependencies, and either succeeds or fails. No mutations needed. A `@Riverpod(keepAlive: true) Future<void>` functional provider is simpler and correct.

3. **AppStartupErrorScreen uses modelNotLoaded error type**: During startup failure the most likely cause is settings or model initialization failure. `AppError.modelNotLoaded` is the semantically correct error to surface. The tone defaults to `ErrorTone.friendly` if settings themselves failed to load.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Added TestWidgetsFlutterBinding.ensureInitialized() to theme test**
- **Found during:** Task 2 (unit test execution)
- **Issue:** `buildDarkTheme()` calls `GoogleFonts.latoTextTheme()` which attempts to load assets via `ServicesBinding`. In a non-widget test context (plain `test()` inside `setUp()`), the binding is not initialized, causing all 10 theme tests to fail with "Binding has not yet been initialized."
- **Fix:** Added `setUpAll(() { TestWidgetsFlutterBinding.ensureInitialized(); })` as the first group in `main()`
- **Files modified:** `test/core/theme/app_theme_test.dart`
- **Verification:** All 10 theme tests pass after fix
- **Committed in:** `b73f2cc` (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 - Bug)
**Impact on plan:** Required for test correctness; google_fonts testing requirement documented. No scope creep.

## Issues Encountered

- `GoogleFonts.latoTextTheme()` in non-widget tests requires `TestWidgetsFlutterBinding.ensureInitialized()`. This is a standard Flutter pattern for testing code that touches asset loading, documented at https://github.com/flutter/packages/blob/main/packages/google_fonts/example/test. Fixed in the same task commit.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 3 is fully complete: theme, localization (10 languages + RTL Arabic), settings persistence, error message resolver, and app wiring are all in place
- Phase 4 (Core Inference Arch) can extend `appStartupProvider` with `await ref.watch(modelReadyProvider.future)` to gate the UI behind model readiness
- `resolveErrorMessage` is ready for all inference error displays in Phases 4-6
- `MainShell` placeholder is ready for Phase 5/6 navigation shell replacement
- All unit tests (20 total) pass

---
*Phase: 03-app-foundation-and-design-system*
*Completed: 2026-02-18*

## Self-Check: PASSED

All claimed files verified present on disk. Both task commits confirmed in git log.
- lib/main.dart: FOUND
- lib/app.dart: FOUND
- lib/widgets/app_startup_widget.dart: FOUND
- lib/widgets/app_startup_widget.g.dart: FOUND
- lib/widgets/model_loading_screen.dart: FOUND
- lib/widgets/app_startup_error_screen.dart: FOUND
- lib/widgets/main_shell.dart: FOUND
- test/core/theme/app_theme_test.dart: FOUND
- test/core/error/error_messages_test.dart: FOUND
- 0ca24fb (Task 1): FOUND
- b73f2cc (Task 2): FOUND
