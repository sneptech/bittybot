# Phase 8, Plan 01: Chat Settings and Maintenance

## Overview

Add a settings screen accessible from the chat drawer (or app shell) with:
1. Auto-clear toggle — configurable time period (7 days, 30 days, 90 days)
2. Clear all history — confirmation dialog, then wipe all sessions and messages
3. Settings persistence via the existing `Settings` provider in `SharedPreferencesWithCache`

## Dependencies

- **Requires Phase 7 complete**: The settings section lives inside (or is accessible from) the chat history drawer. `ChatRepository.deleteAllSessions()` and `ChatRepository.deleteSessionsOlderThan()` already exist from Phase 4.
- **Reuses**: `Settings` notifier, `AppSettings` value object, `ChatRepository` bulk operations, `SharedPreferencesWithCache`

## Success Criteria (from ROADMAP.md)

1. In settings, user can toggle auto-clear on/off and select a time period (7, 30, 90 days); sessions older than the configured period are automatically deleted on next launch
2. Tapping "Clear all history" shows a confirmation dialog with "Are you sure?" before deleting
3. After confirming clear, all sessions and messages are removed and the chat drawer shows empty state
4. The auto-clear setting persists across app restarts

## Architecture Decisions

- **Settings screen as a separate route** (not embedded in drawer): pushed via `Navigator.push` from a gear icon in the drawer or app bar. Modal route keeps the Scaffold stack clean.
- **Auto-clear runs at startup**: `appStartupProvider` triggers auto-clear after settings load, before the main shell is shown. This is the simplest pattern — no background timer needed.
- **Extend existing `AppSettings`**: Add `autoClearEnabled` (bool, default false) and `autoClearDays` (int, default 30) fields. Two new SharedPreferences keys.
- **No separate settings feature presentation** needed — one screen file is sufficient for the current scope (2 settings + 1 action button).

## Files to Create

### 1. `lib/features/settings/presentation/settings_screen.dart`

**Purpose**: Full-screen settings page with auto-clear toggle, time period selector, and clear-all button.

**Widget**: `SettingsScreen extends ConsumerWidget`

**Route**: Pushed via `Navigator.push(context, MaterialPageRoute(builder: (_) => const SettingsScreen()))` from the chat drawer or app bar.

**Layout**:
```
Scaffold
├── AppBar(title: l10n.settings, leading: BackButton)
└── ListView
    ├── _SectionHeader(l10n.chatSettings)
    ├── SwitchListTile(
    │     title: l10n.autoClearHistory,
    │     subtitle: l10n.autoClearDescription,
    │     value: settings.autoClearEnabled,
    │     onChanged: setAutoClearEnabled,
    │   )
    ├── [if autoClearEnabled] ListTile(
    │     title: l10n.autoClearPeriod,
    │     trailing: DropdownButton<int>(
    │       value: settings.autoClearDays,
    │       items: [7, 30, 90].map((d) => DropdownMenuItem(value: d, child: Text(l10n.daysCount(d)))),
    │       onChanged: setAutoClearDays,
    │     ),
    │   )
    ├── Divider
    ├── _SectionHeader(l10n.dangerZone)
    └── ListTile(
          leading: Icon(Icons.delete_forever, color: AppColors.error),
          title: Text(l10n.clearAllHistory, style: TextStyle(color: AppColors.error)),
          onTap: _showClearAllDialog,
        )
```

**Clear all confirmation dialog**:
```dart
Future<void> _showClearAllDialog(BuildContext context, WidgetRef ref) async {
  final confirmed = await showDialog<bool>(
    context: context,
    builder: (ctx) => AlertDialog(
      title: Text(l10n.clearAllHistory),
      content: Text(l10n.clearAllHistoryConfirm),
      actions: [
        TextButton(onPressed: () => Navigator.pop(ctx, false), child: Text(l10n.cancel)),
        TextButton(
          onPressed: () => Navigator.pop(ctx, true),
          child: Text(l10n.clearAllHistoryAction, style: TextStyle(color: AppColors.error)),
        ),
      ],
    ),
  );
  if (confirmed == true) {
    await ref.read(chatRepositoryProvider).deleteAllSessions();
    if (context.mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(l10n.historyCleared)),
      );
      Navigator.pop(context); // return to chat screen
    }
  }
}
```

**Colors**: Standard surface/onSurface. Danger zone uses `AppColors.error` for icon and text.

**Section headers** (`_SectionHeader`, private widget):
```dart
Padding(
  padding: EdgeInsetsDirectional.fromSTEB(16, 16, 16, 8),
  child: Text(text, style: textTheme.titleSmall, color: AppColors.onSurfaceVariant),
)
```

### 2. `lib/features/settings/application/auto_clear_service.dart`

**Purpose**: Stateless helper that runs auto-clear logic at startup.

```dart
/// Runs auto-clear if enabled in settings.
///
/// Called once from [appStartupProvider] after settings load.
/// Deletes sessions older than the configured period using
/// [ChatRepository.deleteSessionsOlderThan].
Future<int> runAutoClearIfEnabled({
  required AppSettings settings,
  required ChatRepository chatRepo,
}) async {
  if (!settings.autoClearEnabled) return 0;

  final cutoff = DateTime.now().subtract(Duration(days: settings.autoClearDays));
  return chatRepo.deleteSessionsOlderThan(cutoff);
}
```

**No provider needed** — this is a pure function called from `appStartupProvider`.

## Files to Modify

### 3. `lib/features/settings/application/settings_provider.dart`

**Add to `AppSettings`**:
```dart
final bool autoClearEnabled;
final int autoClearDays;

const AppSettings({
  // ... existing fields
  this.autoClearEnabled = false,
  this.autoClearDays = 30,
});
```

**Add to `copyWith`**:
```dart
AppSettings copyWith({
  // ... existing params
  bool? autoClearEnabled,
  int? autoClearDays,
}) {
  return AppSettings(
    // ... existing fields
    autoClearEnabled: autoClearEnabled ?? this.autoClearEnabled,
    autoClearDays: autoClearDays ?? this.autoClearDays,
  );
}
```

**Add to `Settings` notifier**:
```dart
static const _kAutoClearEnabledKey = 'auto_clear_enabled';
static const _kAutoClearDaysKey = 'auto_clear_days';

// In build():
final autoClearEnabled = _prefs.getBool(_kAutoClearEnabledKey) ?? false;
final autoClearDays = _prefs.getInt(_kAutoClearDaysKey) ?? 30;

return AppSettings(
  // ... existing fields
  autoClearEnabled: autoClearEnabled,
  autoClearDays: autoClearDays,
);

// New methods:
Future<void> setAutoClearEnabled(bool enabled) async {
  await _prefs.setBool(_kAutoClearEnabledKey, enabled);
  final current = state.value ?? const AppSettings();
  state = AsyncValue.data(current.copyWith(autoClearEnabled: enabled));
}

Future<void> setAutoClearDays(int days) async {
  await _prefs.setInt(_kAutoClearDaysKey, days);
  final current = state.value ?? const AppSettings();
  state = AsyncValue.data(current.copyWith(autoClearDays: days));
}
```

### 4. `lib/widgets/app_startup_widget.dart`

**Add auto-clear call** in `appStartupProvider` after settings load:

```dart
// After settings are loaded:
final settings = await ref.read(settingsProvider.future);
await runAutoClearIfEnabled(
  settings: settings,
  chatRepo: ref.read(chatRepositoryProvider),
);
```

**Add import**: `import '../features/settings/application/auto_clear_service.dart';`

### 5. `lib/features/chat/presentation/widgets/chat_history_drawer.dart`

**Add settings gear icon** to the drawer header:
```dart
IconButton(
  icon: Icon(Icons.settings, color: AppColors.onSurfaceVariant),
  tooltip: l10n.settings,
  onPressed: () {
    Navigator.pop(context); // close drawer
    Navigator.push(context, MaterialPageRoute(builder: (_) => const SettingsScreen()));
  },
),
```

### 6. `lib/core/l10n/app_en.arb` (and all 9 other ARB files)

**New l10n keys**:

```json
"chatSettings": "Chat",
"@chatSettings": { "description": "Section header for chat-related settings" },

"autoClearHistory": "Auto-clear history",
"@autoClearHistory": { "description": "Label for the auto-clear toggle switch in settings" },

"autoClearDescription": "Automatically delete old conversations",
"@autoClearDescription": { "description": "Subtitle explaining the auto-clear toggle" },

"autoClearPeriod": "Delete conversations older than",
"@autoClearPeriod": { "description": "Label for the auto-clear time period selector" },

"daysCount": "{count} days",
"@daysCount": { "description": "Time period label showing number of days", "placeholders": { "count": { "type": "int" } } },

"dangerZone": "Data",
"@dangerZone": { "description": "Section header for destructive data operations in settings" },

"clearAllHistory": "Clear all history",
"@clearAllHistory": { "description": "Button label for deleting all chat history" },

"clearAllHistoryConfirm": "Are you sure? All conversations will be permanently deleted. This cannot be undone.",
"@clearAllHistoryConfirm": { "description": "Confirmation dialog body text for clear all history action" },

"clearAllHistoryAction": "Delete all",
"@clearAllHistoryAction": { "description": "Destructive action button label in the clear all confirmation dialog" },

"historyCleared": "All history cleared",
"@historyCleared": { "description": "Snackbar confirmation shown after all history is deleted" }
```

## Provider Wiring Summary

```
settingsProvider (keepAlive, AsyncNotifier)
    ├── watched by SettingsScreen for current settings display
    ├── read by SettingsScreen for setAutoClearEnabled / setAutoClearDays
    └── read by appStartupProvider for auto-clear at launch

chatRepositoryProvider (keepAlive)
    ├── read by SettingsScreen for deleteAllSessions
    └── read by runAutoClearIfEnabled for deleteSessionsOlderThan

appStartupProvider (keepAlive)
    └── calls runAutoClearIfEnabled after settings load
```

## Widget Tree

```
SettingsScreen (ConsumerWidget) — pushed via MaterialPageRoute
└── Scaffold
    ├── AppBar(title: l10n.settings)
    └── ListView
        ├── _SectionHeader("Chat")
        ├── SwitchListTile (auto-clear toggle)
        ├── [conditional] ListTile (period dropdown: 7/30/90 days)
        ├── Divider
        ├── _SectionHeader("Data")
        └── ListTile (clear all — shows AlertDialog on tap)
```

## Execution Steps (for Codex worker)

1. **Modify** `lib/features/settings/application/settings_provider.dart` — extend AppSettings + Settings notifier
2. **Create** `lib/features/settings/application/auto_clear_service.dart`
3. **Run** `cd /home/agent/git/bittybot && dart run build_runner build --delete-conflicting-outputs` (settings provider changed)
4. **Modify** `lib/widgets/app_startup_widget.dart` — add auto-clear call
5. **Create** `lib/features/settings/presentation/settings_screen.dart`
6. **Modify** `lib/features/chat/presentation/widgets/chat_history_drawer.dart` — add settings icon
7. **Add l10n keys** to all 10 ARB files (10 new keys)
8. **Run** `cd /home/agent/git/bittybot && dart run build_runner build --delete-conflicting-outputs`
9. **Run** `cd /home/agent/git/bittybot && flutter analyze`
10. **Commit**: `feat(chat-settings): [T-06] add auto-clear toggle, clear all history, settings screen`

## Tests

### Unit test: `test/features/settings/application/auto_clear_service_test.dart`

1. **Auto-clear disabled**: `autoClearEnabled: false` -> verify `deleteSessionsOlderThan` NOT called
2. **Auto-clear enabled, 30 days**: `autoClearEnabled: true, autoClearDays: 30` -> verify `deleteSessionsOlderThan` called with cutoff ~30 days ago
3. **Returns count**: Verify the function returns the count from the repository

### Widget test: `test/features/settings/presentation/settings_screen_test.dart`

1. **Toggle renders correctly**: Mock settings with `autoClearEnabled: false` -> SwitchListTile is off
2. **Toggle on shows period selector**: Mock settings with `autoClearEnabled: true` -> dropdown visible
3. **Toggle off hides period selector**: `autoClearEnabled: false` -> dropdown not in tree
4. **Clear all shows dialog**: Tap clear all tile -> verify AlertDialog appears with confirmation text
5. **Clear all confirmed**: Confirm dialog -> verify `deleteAllSessions()` called

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Auto-clear deletes active session | `deleteSessionsOlderThan` uses `createdAt`, not `updatedAt`. Active sessions with recent messages have recent `updatedAt` but old `createdAt`. Decision: use `createdAt` which is what the repo already does. If user wants to keep recent conversations, the 7/30/90 day window handles it. |
| Settings screen navigation from drawer | Close drawer first (`Navigator.pop`), then push settings route. Two sequential nav calls work because pop is synchronous. |
| SharedPreferences key collision | New keys use descriptive prefix: `auto_clear_enabled`, `auto_clear_days`. No collision with existing keys. |
| `appStartupProvider` complexity increase | Auto-clear is a single async call (~<100ms for empty DB). No noticeable startup delay. |

## File Ownership

T-06 assignee owns:
- `lib/features/settings/presentation/settings_screen.dart` (new)
- `lib/features/settings/application/auto_clear_service.dart` (new)
- `lib/features/settings/application/settings_provider.dart` (modify — coordinate with other settings users)

T-06 modifies (coordinate with owners):
- `lib/widgets/app_startup_widget.dart` — owned by Reviewer. Reserve before editing.
- `lib/features/chat/presentation/widgets/chat_history_drawer.dart` — owned by Worker-3. Wait for Phase 7 release.
