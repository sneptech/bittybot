# Phase 7, Plan 01: Chat History — Session Drawer with Persistence

## Overview

Build a slide-out drawer listing all previous chat sessions, loaded reactively from the Drift DB. Users can swipe from the left edge or tap a menu icon to open the drawer, tap a session to load its history, or start a new chat. All messages persist across force-quit.

## Dependencies

- **Requires Phase 6 complete**: The drawer attaches to `ChatScreen`'s `Scaffold`. `ChatNotifier.loadSession()` and `ChatNotifier.startNewSession()` are the entry points.
- **Reuses**: `ChatRepository.watchAllSessions()`, `ChatRepository.deleteSession()`, `ChatNotifier.loadSession(sessionId)`, `ChatNotifier.startNewSession()`

## Success Criteria (from ROADMAP.md)

1. Swiping from the left edge or tapping a menu icon opens a drawer with session list
2. Tapping a session loads full message history
3. Messages persist across force-quit
4. "New Chat" button in drawer

## Architecture Decisions

- **Use `Scaffold.drawer`** (not `NavigationDrawer`): simpler, standard Material pattern. `ChatScreen` already has a `Scaffold` — just add the `drawer` parameter.
- **`watchAllSessions()` already filters mode='chat'?** No — it returns all sessions. We need to filter to `mode == 'chat'` in the provider or UI. Decision: filter in the provider for clean separation.
- **Session title**: auto-derived by `ChatNotifier._finishGeneration` (first user message, truncated 50 chars). Null for brand-new empty sessions — show `l10n.newChat` as fallback title.
- **Delete session**: swipe-to-dismiss on individual sessions with `Dismissible` widget + confirmation via `SnackBar` with undo.
- **Drawer closes after selection**: call `Navigator.pop(context)` (closes drawer) then `ref.read(chatProvider.notifier).loadSession(sessionId)`.

## Files to Create

### 1. `lib/features/chat/presentation/widgets/chat_history_drawer.dart`

**Purpose**: The drawer widget showing the session list with new chat button.

**Widget**: `ChatHistoryDrawer extends ConsumerWidget`

**Layout**:
```
Drawer
└── SafeArea
    └── Column
        ├── _DrawerHeader (app name + "New Chat" button)
        ├── Divider
        └── Expanded
            └── _SessionList (reactive list of sessions)
```

**Drawer header** (`_DrawerHeader`, private StatelessWidget):
```dart
Container(
  padding: EdgeInsetsDirectional.fromSTEB(16, 16, 16, 8),
  child: Row(
    children: [
      Expanded(
        child: Text(l10n.chatHistory, style: textTheme.titleLarge, color: AppColors.onSurface),
      ),
      IconButton(
        icon: Icon(Icons.edit_square, color: AppColors.secondary),
        tooltip: l10n.newChat,
        onPressed: () {
          Navigator.pop(context); // close drawer
          ref.read(chatProvider.notifier).startNewSession();
        },
      ),
    ],
  ),
)
```

**Session list** (`_SessionList`, private ConsumerWidget):

Watch `chatSessionsProvider` (NEW — see below). Display as `ListView.builder` with `Dismissible` items.

Each session item (`_SessionTile`, private widget):
```
ListTile(
  title: Text(session.title ?? l10n.newChat, maxLines: 1, overflow: TextOverflow.ellipsis),
  subtitle: Text(_formatDate(session.updatedAt), style: bodySmall, color: onSurfaceVariant),
  selected: session.id == activeSessionId,
  selectedTileColor: AppColors.primaryContainer,
  onTap: () {
    Navigator.pop(context); // close drawer
    ref.read(chatProvider.notifier).loadSession(session.id);
  },
)
```

**Date formatting**: Use relative time — "Just now" (<1 min), "5m ago" (<1 hr), "2h ago" (<24h), "Yesterday", or "Feb 27" for older. Implement as a private `_formatRelativeTime(DateTime dt)` function.

**Empty state**: When no sessions exist, show centered text `l10n.chatHistoryEmpty` (NEW l10n key) with `AppColors.onSurfaceVariant`.

**Swipe to delete** (`Dismissible`):
```dart
Dismissible(
  key: ValueKey(session.id),
  direction: DismissDirection.endToStart,
  background: Container(
    color: AppColors.error,
    alignment: AlignmentDirectional.centerEnd,
    padding: EdgeInsetsDirectional.only(end: 16),
    child: Icon(Icons.delete, color: AppColors.onError),
  ),
  confirmDismiss: (_) => _confirmDelete(context),
  onDismissed: (_) => ref.read(chatRepositoryProvider).deleteSession(session.id),
)
```

**Delete confirmation**: Show `SnackBar` with undo action (delayed delete pattern):
```dart
Future<bool> _confirmDelete(BuildContext context) async {
  // Show confirmation dialog
  return await showDialog<bool>(
    context: context,
    builder: (ctx) => AlertDialog(
      title: Text(l10n.deleteSession),
      content: Text(l10n.deleteSessionConfirm),
      actions: [
        TextButton(onPressed: () => Navigator.pop(ctx, false), child: Text(l10n.cancel)),
        TextButton(onPressed: () => Navigator.pop(ctx, true), child: Text(l10n.ok)),
      ],
    ),
  ) ?? false;
}
```

**Drawer width**: Default Material `Drawer` width (304dp) — no customization needed.

**Colors**: Drawer background: `AppColors.surface`. Selected tile: `AppColors.primaryContainer`.

### 2. `lib/features/chat/application/chat_sessions_provider.dart`

**Purpose**: Auto-dispose StreamProvider that watches all chat sessions (filtered to mode='chat').

```dart
@riverpod
Stream<List<ChatSession>> chatSessions(Ref ref) {
  final chatRepo = ref.watch(chatRepositoryProvider);
  return chatRepo.watchAllSessions().map(
    (sessions) => sessions.where((s) => s.mode == 'chat').toList(),
  );
}
```

**Generated file**: `chat_sessions_provider.g.dart`

**Note**: `watchAllSessions()` returns sessions ordered by `updatedAt DESC` — already correct for the drawer (most recent first).

## Files to Modify

### 3. `lib/features/chat/presentation/chat_screen.dart`

**Changes**:

a) Add `drawer` parameter to `Scaffold`:
```dart
Scaffold(
  drawer: const ChatHistoryDrawer(),
  // ... existing appBar, body
)
```

b) Add menu icon as `leading` in `AppBar`:
```dart
AppBar(
  leading: Builder(
    builder: (context) => IconButton(
      icon: const Icon(Icons.menu),
      color: AppColors.onSurface,
      onPressed: () => Scaffold.of(context).openDrawer(),
    ),
  ),
  // ... existing title, actions
)
```

**Note**: `Builder` is required because `Scaffold.of(context)` needs a context below the `Scaffold` in the widget tree.

c) Add import: `import 'widgets/chat_history_drawer.dart';`

### 4. `lib/core/l10n/app_en.arb` (and all 9 other ARB files)

**New l10n keys** (append before closing `}`):

```json
"chatHistory": "Chat History",
"@chatHistory": { "description": "Title shown at the top of the chat history drawer" },

"newChat": "New Chat",
"@newChat": { "description": "Button label and fallback title for untitled chat sessions in the drawer" },

"chatHistoryEmpty": "No conversations yet",
"@chatHistoryEmpty": { "description": "Empty state text shown in the chat history drawer when no sessions exist" },

"deleteSession": "Delete conversation?",
"@deleteSession": { "description": "Title of the confirmation dialog when deleting a chat session" },

"deleteSessionConfirm": "This conversation will be permanently deleted.",
"@deleteSessionConfirm": { "description": "Body text of the delete session confirmation dialog" },

"justNow": "Just now",
"@justNow": { "description": "Relative time label for events less than 1 minute ago" },

"minutesAgo": "{count}m ago",
"@minutesAgo": { "description": "Relative time label for events N minutes ago", "placeholders": { "count": { "type": "int" } } },

"hoursAgo": "{count}h ago",
"@hoursAgo": { "description": "Relative time label for events N hours ago", "placeholders": { "count": { "type": "int" } } },

"yesterday": "Yesterday",
"@yesterday": { "description": "Relative time label for events that occurred yesterday" }
```

**All 10 ARB files** need translations. Date format for older items uses `DateFormat.MMMd()` from `intl` (already a dependency via `flutter_localizations`).

## Provider Wiring Summary

```
chatRepositoryProvider (keepAlive)
    └── watched by chatSessionsProvider

chatSessionsProvider (auto-dispose, StreamProvider)
    └── watched by ChatHistoryDrawer._SessionList
    └── emits List<ChatSession> filtered to mode='chat', ordered updatedAt DESC

chatProvider (auto-dispose, from ChatNotifier)
    └── read by drawer for loadSession / startNewSession
    └── watched by drawer to highlight active session
```

## Widget Tree (complete for Phase 7 additions)

```
ChatScreen (ConsumerWidget)
└── Scaffold
    ├── drawer: ChatHistoryDrawer (ConsumerWidget)
    │   └── Drawer
    │       └── SafeArea
    │           └── Column
    │               ├── _DrawerHeader
    │               │   └── Row [title, new-chat IconButton]
    │               ├── Divider
    │               └── Expanded
    │                   └── _SessionList (ConsumerWidget)
    │                       └── ListView.builder
    │                           └── Dismissible
    │                               └── _SessionTile (ListTile)
    ├── AppBar
    │   ├── leading: IconButton(Icons.menu) -> openDrawer
    │   ├── title: l10n.chat
    │   └── actions: [new session]
    └── body: Column (unchanged from Phase 6)
```

## Execution Steps (for Codex worker)

1. **Create** `lib/features/chat/application/chat_sessions_provider.dart`
2. **Run** `cd /home/agent/git/bittybot && dart run build_runner build --delete-conflicting-outputs`
3. **Create** `lib/features/chat/presentation/widgets/chat_history_drawer.dart`
4. **Modify** `lib/features/chat/presentation/chat_screen.dart`:
   - Add `drawer: const ChatHistoryDrawer()`
   - Add `leading:` menu icon in AppBar
   - Add import
5. **Add l10n keys** to all 10 ARB files
6. **Run** `cd /home/agent/git/bittybot && dart run build_runner build --delete-conflicting-outputs`
7. **Run** `cd /home/agent/git/bittybot && flutter analyze` — fix any issues
8. **Commit**: `feat(chat-history): [T-05] implement chat history drawer with session management`

## Tests

### Widget test: `test/features/chat/presentation/widgets/chat_history_drawer_test.dart`

1. **Empty state**: Mock `chatSessionsProvider` returning empty list -> verify `chatHistoryEmpty` text shown
2. **Session list**: Mock with 3 sessions -> verify 3 ListTiles rendered with correct titles
3. **Active session highlighted**: Set active session ID -> verify `selectedTileColor` applied
4. **New Chat button**: Tap new-chat icon -> verify `startNewSession()` called on notifier
5. **Session tap loads history**: Tap a session tile -> verify `loadSession(sessionId)` called
6. **Untitled session fallback**: Session with `title: null` -> verify `newChat` l10n text shown

### Unit test: `test/features/chat/application/chat_sessions_provider_test.dart`

1. **Filters to chat mode**: Mock `watchAllSessions` returning mix of chat and translation sessions -> verify only chat sessions emitted
2. **Order preserved**: Verify sessions arrive in updatedAt DESC order

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Drawer gesture conflicts with NavigationBar swipe | `Scaffold.drawer` uses Material edge-swipe — works alongside `NavigationBar` tabs since `IndexedStack` doesn't intercept horizontal gestures |
| `loadSession` clears KV cache | By design: `ChatNotifier.loadSession` sets `_turnCount = 0`. Next send uses `buildInitialPrompt`. This is correct — we don't replay messages into KV cache. |
| Session list grows unbounded | Phase 8 adds auto-clear. For now, `ListView.builder` handles large lists efficiently. |
| `watchAllSessions` returns translation sessions too | Filtered in `chatSessionsProvider` via `.where((s) => s.mode == 'chat')` |
| Drawer opens over AppBar | Standard `Scaffold.drawer` behaviour — drawer overlays the full screen. Correct. |

## File Ownership

Worker-3 (T-05) owns:
- `lib/features/chat/presentation/widgets/chat_history_drawer.dart` (new)
- `lib/features/chat/application/chat_sessions_provider.dart` (new)
- `lib/widgets/chat_drawer/**` (per AGENTS.md, but actual path is under `lib/features/chat/presentation/widgets/`)

Worker-3 modifies:
- `lib/features/chat/presentation/chat_screen.dart` — coordinate with Worker-2 (T-03). Worker-3 should wait for Phase 6 to complete before modifying this file. Send message to BlueMountain confirming readiness.

### Sequencing Note

Phase 7 **must wait** for Phase 6 to complete. Worker-3 should:
1. Write the provider file and drawer widget immediately (no dependency on Phase 6 files)
2. Wait for Worker-2 to signal Phase 6 completion
3. Then modify `chat_screen.dart` to add drawer + menu icon
4. Run build_runner, analyze, and commit
