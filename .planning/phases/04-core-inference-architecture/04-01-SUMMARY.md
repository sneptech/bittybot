---
phase: 04-core-inference-architecture
plan: "01"
subsystem: database, inference
tags: [drift, sqlite, dart-isolate, llama-cpp-dart, aya, prompt-engineering]

# Dependency graph
requires:
  - phase: 03-app-foundation
    provides: AppDatabase stub (schemaVersion 1, empty tables), appStartupProvider hook, Riverpod 3.1.0 pinned
  - phase: 02-model-distribution
    provides: GGUF model file path via ModelDistributionNotifier.modelFilePath

provides:
  - Drift ChatSessions and ChatMessages tables (schemaVersion 2, migration from v1)
  - Sealed InferenceCommand hierarchy (5 variants) for main→isolate IPC
  - Sealed InferenceResponse hierarchy (4 variants) for isolate→main IPC
  - PromptBuilder with Aya chat template and translation/chat system prompts

affects:
  - 04-02 (LlmService — imports InferenceCommand, InferenceResponse)
  - 04-03 (ChatNotifier — imports ChatSessions, ChatMessages, PromptBuilder)
  - 05-translation-ui
  - 06-chat-ui

# Tech tracking
tech-stack:
  added: []  # No new packages — all deps already in pubspec.yaml from Phases 2-3
  patterns:
    - Drift schema v2 with MigrationStrategy (onCreate + onUpgrade from v1 + beforeOpen WAL/FK pragmas)
    - Sealed class IPC protocol for Dart isolate SendPort communication (all fields primitive)
    - PromptBuilder static methods for Aya chat template — buildInitialPrompt vs buildFollowUpPrompt distinction
    - Conservative token estimation (2 chars/token CJK worst-case) for context-full detection

key-files:
  created:
    - lib/features/inference/domain/inference_message.dart
    - lib/features/inference/domain/prompt_builder.dart
  modified:
    - lib/core/db/app_database.dart
    - lib/core/db/app_database.g.dart

key-decisions:
  - "Drift generated row type is ChatSession/ChatMessage (not ChatSessionData/ChatMessageData) — fixed watchMessagesForSession return type"
  - "Sealed base classes need const constructors for subclass const support — added const InferenceCommand() and const InferenceResponse()"
  - "PromptBuilder.estimateTokenCount uses 2 chars/token (CJK worst-case) to over-estimate and warn earlier"
  - "No wrapAssistantResponse method — KV cache handles assistant response context via setPrompt() appending"

patterns-established:
  - "Pattern: Drift table classes defined ABOVE AppDatabase class in same file (Drift convention)"
  - "Pattern: WAL mode + foreign_keys enabled in MigrationStrategy.beforeOpen for concurrent inference reads"
  - "Pattern: InferenceCommand/Response sealed classes carry only primitive fields (int, String, bool) — SendPort-safe"
  - "Pattern: buildInitialPrompt for first message (includes system prompt), buildFollowUpPrompt for subsequent (KV cache append)"

requirements-completed: [MODL-05, CHAT-04]

# Metrics
duration: 4min
completed: 2026-02-25
---

# Phase 4 Plan 01: Foundational Data Contracts Summary

**Drift ChatSessions+ChatMessages schema (v2 with WAL), sealed isolate IPC protocol (5 commands, 4 responses), and PromptBuilder with Aya chat template and offline system prompts**

## Performance

- **Duration:** ~4 min
- **Started:** 2026-02-25T04:40:59Z
- **Completed:** 2026-02-25T04:44:30Z
- **Tasks:** 3
- **Files modified:** 4 (2 created, 2 modified + regenerated)

## Accomplishments

- Extended Phase 3's empty Drift stub to schema v2 with ChatSessions and ChatMessages tables, onUpgrade migration from v1, WAL mode, and foreign key enforcement
- Created sealed InferenceCommand/InferenceResponse hierarchies with all primitive fields, making the types safe to send across Dart isolate SendPort boundaries
- Implemented PromptBuilder with the Aya chat template format confirmed from the Phase 1 spike, plus short directive system prompts for translation and chat modes

## Task Commits

Each task was committed atomically:

1. **Task 1: Drift schema — ChatSessions and ChatMessages tables with migration** - `1a2be11` (feat)
2. **Task 2: Inference message protocol — sealed command and response types** - `973caa0` (feat)
3. **Task 3: PromptBuilder — Aya chat template with system prompts** - `21b1741` (feat)

**Plan metadata:** (docs commit, see below)

## Files Created/Modified

- `lib/core/db/app_database.dart` - ChatSessions and ChatMessages table definitions, schemaVersion 2, MigrationStrategy with WAL+FK pragmas, watchMessagesForSession() helper
- `lib/core/db/app_database.g.dart` - Regenerated by Drift build_runner; contains ChatSession, ChatMessage data classes and companion types
- `lib/features/inference/domain/inference_message.dart` - Sealed InferenceCommand (LoadModel, Generate, Stop, ClearContext, Shutdown) and InferenceResponse (ModelReady, Token, Done, Error) hierarchies
- `lib/features/inference/domain/prompt_builder.dart` - PromptBuilder with buildInitialPrompt, buildFollowUpPrompt, buildTranslationPrompt, buildFollowUpTranslationPrompt, estimateTokenCount

## Decisions Made

- Drift generates row types as `ChatSession`/`ChatMessage` (not `ChatSessionData`/`ChatMessageData`) — corrected return type on `watchMessagesForSession()`
- Sealed base classes require `const` constructors to allow subclass `const` constructors — added `const InferenceCommand()` and `const InferenceResponse()` to the sealed base classes
- `estimateTokenCount` uses 2 chars/token (CJK worst-case) rather than 4 chars/token (Latin) — intentional over-estimate to trigger context-full warning early
- No `wrapAssistantResponse` method per plan spec — the KV cache handles assistant response context via `Llama.setPrompt()` appending

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Sealed base class missing const constructor caused subclass const errors**
- **Found during:** Task 2 (InferenceCommand sealed class)
- **Issue:** `sealed class InferenceCommand {}` with empty body doesn't have a const constructor. All subclasses used `const` constructors which requires the superclass to also have one. Dart analyzer reported 9 errors: "A constant constructor can't call a non-constant super constructor"
- **Fix:** Added `const InferenceCommand()` and `const InferenceResponse()` constructors to both sealed base classes
- **Files modified:** `lib/features/inference/domain/inference_message.dart`
- **Verification:** `dart analyze` returned "No issues found" after fix
- **Committed in:** `973caa0` (Task 2 commit)

**2. [Rule 1 - Bug] Wrong return type ChatMessageData in watchMessagesForSession()**
- **Found during:** Task 1 (app_database.dart reactive helper method)
- **Issue:** Used `ChatMessageData` as the return type in `Stream<List<ChatMessageData>>` — Drift generates the row class as `ChatMessage` not `ChatMessageData`. Analyzer reported: "The name 'ChatMessageData' isn't a type"
- **Fix:** Changed return type to `Stream<List<ChatMessage>>`
- **Files modified:** `lib/core/db/app_database.dart`
- **Verification:** `dart analyze lib/core/db/app_database.dart` returned "No issues found" after fix
- **Committed in:** `1a2be11` (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (both Rule 1 — type/const errors discovered during analysis)
**Impact on plan:** Both auto-fixes required for zero-error compilation. No scope creep — only corrected incorrect type assumptions in the plan spec.

## Issues Encountered

None — code generation (build_runner) succeeded on first run in 33s.

## User Setup Required

None — no external service configuration required.

## Next Phase Readiness

- All three data contract files are ready to import. Phase 4 plans 02+ (LlmService, ChatNotifier, TranslationNotifier) can proceed immediately.
- `lib/features/inference/domain/` directory is created; application and repository subdirectories will be added by later plans.
- The `watchMessagesForSession()` helper on AppDatabase is ready for ChatNotifier to use.
- Drift schema v2 is confirmed compiling with zero analyzer errors across `lib/core/db/` and `lib/features/inference/domain/`.

## Self-Check: PASSED

- FOUND: lib/core/db/app_database.dart
- FOUND: lib/core/db/app_database.g.dart
- FOUND: lib/features/inference/domain/inference_message.dart
- FOUND: lib/features/inference/domain/prompt_builder.dart
- FOUND: .planning/phases/04-core-inference-architecture/04-01-SUMMARY.md
- FOUND commit: 1a2be11 (Drift schema)
- FOUND commit: 973caa0 (InferenceCommand/Response)
- FOUND commit: 21b1741 (PromptBuilder)

---
*Phase: 04-core-inference-architecture*
*Completed: 2026-02-25*
