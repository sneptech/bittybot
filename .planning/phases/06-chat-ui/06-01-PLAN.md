# Phase 6, Plan 01: Chat UI — Multi-turn Chat Screen with Streaming

## Overview

Build the chat screen that replaces the Phase 3 placeholder in `MainShell` tab index 1. Users type messages, see them appear instantly, watch the model stream a reply word-by-word, and can stop generation mid-response. Reuses `ChatNotifier` (Phase 4) and `DriftChatRepository` (Phase 4) — no new backend code needed.

## Success Criteria (from ROADMAP.md)

1. User sends message -> appears immediately -> model streams reply word-by-word
2. Stop button visible during generation -> halts and shows partial text
3. 10+ turn conversation without UI slowdown
4. Input disabled while model not ready (via `modelReadyProvider`)

## Architecture Decisions

- **ChatNotifier is auto-dispose** (`@riverpod`): state reloads from DB per screen entry. The DB is source of truth.
- **nPredict=512** for chat mode (already locked in ChatNotifier).
- **Word-level batching**: reuse the same `_isSpaceDelimited` / `_streamingDisplayText` pattern from `TranslationBubbleList`.
- **Session auto-creation**: `ChatNotifier._processMessage` creates a session if `activeSession == null`. No explicit "new chat" needed on first send.
- **Title auto-derive**: `ChatNotifier._finishGeneration` sets session title to first user message (truncated 50 chars).
- **Context-full banner**: shown when `ChatState.isContextFull` is true, with "Start new session" button calling `startNewSessionWithCarryForward()`.

## Files to Create

### 1. `lib/features/chat/presentation/chat_screen.dart`

**Purpose**: Main chat screen widget — the Scaffold that holds the bubble list and input bar.

**Widget**: `ChatScreen extends ConsumerWidget`

**Layout** (mirror TranslationScreen pattern):
```
Scaffold
├── AppBar
│   ├── title: Text(l10n.chat)
│   └── actions: [IconButton(icon: Icons.note_add_outlined, onPressed: startNewSession)]
├── body: Column
│   ├── if (state.isContextFull) _ContextFullBanner(onNewSession: startNewSessionWithCarryForward)
│   ├── Expanded(child: ChatBubbleList())
│   └── ChatInputBar()
```

**Provider wiring**:
```dart
final state = ref.watch(chatProvider);
// chatProvider is the generated name from ChatNotifier (riverpod_generator strips "Notifier")
```

**CRITICAL**: The generated provider name is `chatProvider` (not `chatNotifierProvider`). Same pattern as `translationProvider` from Phase 5.

**AppBar details**:
- Title: `Text(l10n.chat)` with `textTheme.titleMedium`, color `AppColors.onSurface`
- New session button: `IconButton(icon: Icons.note_add_outlined)` — disabled during generation (`state.isGenerating`), calls `ref.read(chatProvider.notifier).startNewSession()`
- No language picker (chat has no language selection)

**Context-full banner**: Copy `_ContextFullBanner` from `translation_screen.dart` — identical pattern. Use `l10n.contextFullBanner` (already exists) and `l10n.newSession` (already exists). `onNewSession` calls `ref.read(chatProvider.notifier).startNewSessionWithCarryForward()`.

### 2. `lib/features/chat/presentation/widgets/chat_bubble_list.dart`

**Purpose**: Chat-style bubble list showing persisted messages + streaming response.

**Widget**: `ChatBubbleList extends ConsumerStatefulWidget`

**Message sourcing** (same pattern as TranslationBubbleList):
- Persisted messages: create a `chatSessionMessagesProvider` (StreamProvider.family) that wraps `ChatRepository.watchMessagesForSession(sessionId)`
- In-progress streaming: from `ChatState.currentResponse`
- Typing indicator: shown when `state.isGenerating && state.currentResponse.isEmpty`

**Bubble styling** (same as TranslationBubbleList):
- User bubbles: `AlignmentDirectional.centerEnd`, `AppColors.primaryContainer`, rounded corners (TL:16, TR:16, BL:16, BR:4)
- Assistant bubbles: `AlignmentDirectional.centerStart`, `AppColors.surfaceContainer`, rounded corners (TL:16, TR:16, BL:4, BR:16)
- Max width: `MediaQuery.of(context).size.width * 0.80`
- Margins: user `EdgeInsetsDirectional.fromSTEB(48, 4, 12, 4)`, assistant `EdgeInsetsDirectional.fromSTEB(12, 4, 48, 4)`
- Padding: `EdgeInsetsDirectional.fromSTEB(12, 10, 12, 10)`

**Key differences from TranslationBubbleList**:
- No `targetLanguage` subtitle on assistant bubbles (chat doesn't have a language label)
- Long-press copy menu identical (`_showBubbleMenu` with `Clipboard.setData`)
- Use `l10n.copyMessage` (NEW l10n key, see below) instead of `l10n.copyTranslation`

**Word-level batching**: Copy `_isSpaceDelimited` and `_streamingDisplayText` exactly from `TranslationBubbleList`.

**Auto-scroll**: Same `_scrollToBottom()` pattern — `addPostFrameCallback`, check within 100px, `animateTo` with 300ms easeOut.

**Empty state**: Center text `l10n.chatEmptyState` (NEW l10n key) with `AppColors.onSurfaceVariant`.

### 3. `lib/features/chat/presentation/widgets/chat_input_bar.dart`

**Purpose**: Multi-line text input with send/stop toggle — mirrors TranslationInputBar.

**Widget**: `ChatInputBar extends ConsumerStatefulWidget`

**Behaviour** (same as TranslationInputBar):
- `TextField` with `minLines: 1`, `maxLines: 6`, `TextInputAction.newline`
- `enabled: state.isModelReady` — disabled until model loads
- Send button: `IconButton(icon: Icons.send)`, disabled when empty or model not ready
- Stop button: `IconButton(icon: Icons.stop_circle)`, shown when `state.isGenerating`
- `AnimatedSwitcher` for smooth send/stop icon transition
- On send: `_textController.clear()` then `ref.read(chatProvider.notifier).sendMessage(text)`
- On stop: `ref.read(chatProvider.notifier).stopGeneration()`

**Character limit**: Same soft limit pattern — counter at 400+, error colour at 500+. Chat allows longer input than translation (500 char soft limit same as translation — model nPredict is the real limiter).

**Hint text**: `l10n.chatInputHint` (NEW l10n key)

### 4. `lib/features/chat/application/chat_session_messages_provider.dart`

**Purpose**: Auto-dispose StreamProvider.family that watches messages for a given session ID.

**Pattern**: Mirror `session_messages_provider.dart` from translation feature.

```dart
@riverpod
Stream<List<ChatMessage>> chatSessionMessages(
  Ref ref,
  int sessionId,
) {
  final chatRepo = ref.watch(chatRepositoryProvider);
  return chatRepo.watchMessagesForSession(sessionId);
}
```

**Generated file**: `chat_session_messages_provider.g.dart` (run `dart run build_runner build`)

## Files to Modify

### 5. `lib/widgets/main_shell.dart`

**Change**: Replace the Phase 6 placeholder `Center(child: Text(l10n.chat))` with `const ChatScreen()`.

**Add import**: `import '../features/chat/presentation/chat_screen.dart';`

**IndexedStack children** after change:
```dart
children: [
  const TranslationScreen(),
  const ChatScreen(),  // was placeholder
],
```

### 6. `lib/core/l10n/app_en.arb` (and all 9 other ARB files)

**New l10n keys to add** (append before closing `}`):

```json
"chatEmptyState": "Start a conversation",
"@chatEmptyState": { "description": "Centered empty-state prompt shown in the chat screen when no messages exist" },

"chatInputHint": "Type a message",
"@chatInputHint": { "description": "Placeholder text in the chat input field" },

"copyMessage": "Copy message",
"@copyMessage": { "description": "Label for the copy action in the long-press context menu on chat bubbles" }
```

**All 10 ARB files** need these keys. For non-English files, provide translated versions:
- `lib/core/l10n/app_ar.arb` (Arabic)
- `lib/core/l10n/app_de.arb` (German)
- `lib/core/l10n/app_es.arb` (Spanish)
- `lib/core/l10n/app_fr.arb` (French)
- `lib/core/l10n/app_hi.arb` (Hindi)
- `lib/core/l10n/app_ja.arb` (Japanese)
- `lib/core/l10n/app_ko.arb` (Korean)
- `lib/core/l10n/app_pt.arb` (Portuguese)
- `lib/core/l10n/app_zh.arb` (Chinese)

## Provider Wiring Summary

```
modelReadyProvider (keepAlive, AsyncNotifier)
    └── watched by ChatNotifier.build() -> state.isModelReady

chatRepositoryProvider (keepAlive)
    └── read by ChatNotifier for all DB ops

inferenceRepositoryProvider (keepAlive, throws if model not ready)
    └── read by ChatNotifier for generate/stop/clearContext

chatProvider (auto-dispose, from ChatNotifier)
    └── watched by ChatScreen, ChatBubbleList, ChatInputBar

chatSessionMessagesProvider (auto-dispose, StreamProvider.family)
    └── watched by ChatBubbleList with sessionId from ChatState.activeSession?.id
```

## Widget Tree (complete)

```
MainShell (ConsumerStatefulWidget, IndexedStack index=1)
└── ChatScreen (ConsumerWidget)
    └── Scaffold
        ├── AppBar(title: l10n.chat, actions: [new session])
        └── Column
            ├── [conditional] _ContextFullBanner
            ├── Expanded
            │   └── ChatBubbleList (ConsumerStatefulWidget)
            │       └── ListView.builder
            │           ├── [0..N-1] _buildUserBubble / _buildAssistantBubble
            │           ├── [N] TypingIndicator (reuse from translation)
            │           └── [N+1] streaming assistant bubble (copy disabled)
            └── ChatInputBar (ConsumerStatefulWidget)
                └── SafeArea(bottom: true)
                    └── Column
                        ├── Row
                        │   ├── Expanded(TextField)
                        │   └── IconButton(send/stop)
                        └── [conditional] character counter
```

## Reused Components

| Component | Source | Usage |
|-----------|--------|-------|
| `TypingIndicator` | `lib/features/translation/presentation/widgets/typing_indicator.dart` | Import directly — same widget works for chat |
| `AppColors` | `lib/core/theme/app_colors.dart` | All colour constants |
| `AppLocalizations` | `lib/core/l10n/app_localizations.dart` | All l10n strings |
| `ChatNotifier` / `chatProvider` | `lib/features/chat/application/chat_notifier.dart` | State management |
| `ChatRepository` | `lib/features/chat/data/chat_repository.dart` | DB ops via provider |

## Execution Steps (for Codex worker)

1. **Create** `lib/features/chat/application/chat_session_messages_provider.dart`
2. **Run** `cd /home/agent/git/bittybot && dart run build_runner build --delete-conflicting-outputs` to generate `.g.dart`
3. **Create** `lib/features/chat/presentation/widgets/chat_bubble_list.dart`
4. **Create** `lib/features/chat/presentation/widgets/chat_input_bar.dart`
5. **Create** `lib/features/chat/presentation/chat_screen.dart`
6. **Modify** `lib/widgets/main_shell.dart` — replace placeholder with `ChatScreen`
7. **Add l10n keys** to all 10 ARB files (`chatEmptyState`, `chatInputHint`, `copyMessage`)
8. **Run** `cd /home/agent/git/bittybot && dart run build_runner build --delete-conflicting-outputs` (l10n codegen)
9. **Run** `cd /home/agent/git/bittybot && flutter analyze` — fix any issues
10. **Commit**: `feat(chat-ui): [T-03] implement chat screen with streaming bubbles and input bar`

## Tests

### Unit test: `test/features/chat/application/chat_session_messages_provider_test.dart`

Test that `chatSessionMessagesProvider` returns a stream from the repository. Mock `ChatRepository` and verify `watchMessagesForSession` is called with the correct session ID.

### Widget test: `test/features/chat/presentation/chat_screen_test.dart`

1. **Empty state**: Pump `ChatScreen` with mock providers returning empty state -> verify `chatEmptyState` text is shown
2. **User bubble**: Set state with one user message -> verify bubble aligned end, correct colour
3. **Assistant bubble**: Set state with assistant message -> verify bubble aligned start, correct colour
4. **Input disabled when model not ready**: Set `isModelReady: false` -> verify TextField is disabled
5. **Stop button visible during generation**: Set `isGenerating: true` -> verify stop icon is shown
6. **Send button visible when not generating**: Set `isGenerating: false` -> verify send icon is shown

### Widget test: `test/features/chat/presentation/widgets/chat_input_bar_test.dart`

1. **Send clears input**: Enter text, tap send -> verify controller is cleared
2. **Send disabled on empty**: No text -> verify send button is disabled (null onPressed)
3. **Character counter at 400+**: Enter 401 chars -> verify counter is visible

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| `chatProvider` name wrong | Verified: `riverpod_generator` strips `Notifier` suffix. `ChatNotifier` -> `chatProvider`. |
| TypingIndicator import path | Import from `../../translation/presentation/widgets/typing_indicator.dart` — cross-feature import is OK for shared widgets |
| Keyboard hides input | `Scaffold.resizeToAvoidBottomInset` defaults to `true` — same as TranslationScreen |
| ListView performance at 10+ turns | `ListView.builder` is lazy — only visible items are built. 10 turns = ~20 items, trivial. |
| StreamProvider rebuild storm | `chatSessionMessagesProvider` is auto-dispose + family keyed on sessionId — disposes when ChatScreen leaves, no leak |

## File Ownership

Worker-2 (T-03) owns:
- `lib/features/chat/presentation/**` (new files)
- `lib/features/chat/application/chat_session_messages_provider.dart` (new)

Worker-2 must coordinate with Reviewer for `lib/widgets/main_shell.dart` modification (currently owned by Reviewer for T-01). Send a message to BlueMountain requesting permission before editing `main_shell.dart`.
