---
phase: 01-inference-spike
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/main.dart
  - pubspec.yaml
  - android/app/build.gradle
  - android/app/build.gradle.kts
  - android/build.gradle
  - android/build.gradle.kts
  - android/gradle.properties
  - ios/Runner.xcodeproj/project.pbxproj
  - ios/Runner/Runner.entitlements
  - ios/Podfile
  - integration_test/helpers/language_corpus.dart
autonomous: true
requirements:
  - MODL-06

must_haves:
  truths:
    - "Flutter project compiles for both iOS and Android without errors"
    - "Android build targets NDK r28+ in build configuration"
    - "iOS project is configured for physical device deployment with static linking"
    - "Language corpus contains all 70+ Aya-supported languages with correct metadata"
    - "Priority languages (Mandarin, Cantonese, Latin American Spanish, English) have travel phrases"
  artifacts:
    - path: "pubspec.yaml"
      provides: "Flutter project dependencies including llama_cpp_dart, background_downloader, path_provider"
      contains: "llama_cpp_dart"
    - path: "android/app/build.gradle.kts"
      provides: "Android build config with NDK r28+"
      contains: "ndkVersion"
    - path: "ios/Runner/Runner.entitlements"
      provides: "iOS Extended Virtual Addressing entitlement"
      contains: "extended-virtual-addressing"
    - path: "integration_test/helpers/language_corpus.dart"
      provides: "Complete 70+ language test data with prompts and metadata"
      min_lines: 200
    - path: "lib/main.dart"
      provides: "Minimal Flutter app scaffold required for integration tests"
  key_links:
    - from: "pubspec.yaml"
      to: "integration_test/"
      via: "dev_dependencies include integration_test and flutter_test"
      pattern: "integration_test"
---

<objective>
Bootstrap the Flutter project with all dependencies, configure platform toolchains for iOS physical device and Android NDK r28+ compliance, and create the comprehensive 70+ language test corpus that all subsequent spike tests will use.

Purpose: Establish the project foundation and test data so that model loading, streaming, and multilingual tests can be written and executed on real hardware.
Output: A compilable Flutter project with correct platform settings, and a language corpus covering all 70+ Aya languages with travel phrases for priority languages and reference sentences for the rest.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-inference-spike/01-RESEARCH.md
@.planning/phases/01-inference-spike/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Flutter project with dependencies and platform toolchain configuration</name>
  <files>
    lib/main.dart
    pubspec.yaml
    android/app/build.gradle
    android/app/build.gradle.kts
    android/build.gradle
    android/build.gradle.kts
    android/gradle.properties
    ios/Runner.xcodeproj/project.pbxproj
    ios/Runner/Runner.entitlements
    ios/Podfile
  </files>
  <action>
    1. Run `flutter create --org com.bittybot bittybot` in the project root (or `flutter create .` if already in bittybot dir). The project root IS /home/max/git/bittybot — create the Flutter project here directly, not in a subdirectory.

    2. Add production dependencies:
       ```
       flutter pub add llama_cpp_dart
       flutter pub add background_downloader
       flutter pub add path_provider
       ```

    3. Add dev dependencies:
       ```
       flutter pub add --dev integration_test --sdk flutter
       flutter pub add --dev flutter_test --sdk flutter
       ```

    4. Configure Android NDK r28+ in `android/app/build.gradle.kts` (or `build.gradle` depending on what `flutter create` generates):
       - Set `ndkVersion = "28.0.12674087"` in the `android {}` block
       - Ensure `minSdk` is at least 24 (llama.cpp requires this)
       - Ensure `compileSdk` is at least 35

    5. Configure Android Gradle properties in `android/gradle.properties`:
       - Add `android.enableR8=true`

    6. Configure iOS in `ios/Podfile`:
       - Set minimum iOS deployment target to 14.0: `platform :ios, '14.0'`

    7. Configure iOS entitlements — create `ios/Runner/Runner.entitlements` with:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
       <plist version="1.0">
       <dict>
         <key>com.apple.developer.kernel.extended-virtual-addressing</key>
         <true/>
       </dict>
       </plist>
       ```

    8. Update iOS project to reference the entitlements file in the Xcode project build settings. The entitlements must be set for both Debug and Release configurations in `ios/Runner.xcodeproj/project.pbxproj`:
       - `CODE_SIGN_ENTITLEMENTS = Runner/Runner.entitlements;`

    9. In `ios/Podfile`, add post_install hook to ensure Metal framework is linked and arm64 only:
       ```ruby
       post_install do |installer|
         installer.pods_project.targets.each do |target|
           target.build_configurations.each do |config|
             config.build_settings['OTHER_LDFLAGS'] ||= ['$(inherited)']
             config.build_settings['OTHER_LDFLAGS'] << '-framework Metal'
             config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64 x86_64'
           end
         end
       end
       ```
       Note: Exclude ALL simulator archs since we only target physical device for the spike. Simulator cannot run Metal-based llama.cpp inference.

    10. Create a minimal `lib/main.dart` that just runs a MaterialApp with a placeholder screen. This is required for integration_test to launch.

    11. Run `flutter pub get` to verify all dependencies resolve.

    IMPORTANT: Do NOT run `flutter build` yet — just verify the project structure is correct and dependencies resolve. The actual build will happen during integration test execution on-device.

    AVOID:
    - Do not set up Simulator builds (Metal not available)
    - Do not use dynamic library embedding on iOS ("Do Not Embed" for static XCFramework)
    - Do not use NDK below r28 (4KB alignment fails Play Store)
  </action>
  <verify>
    - `flutter pub get` completes without errors
    - `flutter analyze` has no errors (warnings acceptable)
    - `grep -r "ndkVersion" android/` shows r28+ version
    - `ios/Runner/Runner.entitlements` exists with extended-virtual-addressing key
    - `grep "platform :ios" ios/Podfile` shows 14.0+
  </verify>
  <done>
    Flutter project compiles dependency resolution successfully. Android is configured for NDK r28+. iOS is configured with Extended Virtual Addressing, Metal framework linkage, and physical-device-only targeting. All dependencies (llama_cpp_dart, background_downloader, path_provider, integration_test, flutter_test) are resolved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive 70+ language test corpus with travel phrases and reference sentences</name>
  <files>
    integration_test/helpers/language_corpus.dart
  </files>
  <action>
    Create `integration_test/helpers/language_corpus.dart` containing the complete test corpus for all Aya-supported languages.

    **Data structure:**
    ```dart
    enum LanguagePriority { mustHave, standard }
    enum ScriptFamily { latin, arabic, thai, cjk, cyrillic, devanagari, bengali, tamil, telugu, gujarati, gurmukhi, khmer, lao, burmese, ethiopic, other }

    class LanguageTestData {
      final String languageName;        // e.g., "Chinese (Mandarin)"
      final String nativeName;          // e.g., "中文 (普通话)"
      final String languageCode;        // e.g., "zh"
      final ScriptFamily scriptFamily;
      final LanguagePriority priority;
      final List<TestPrompt> prompts;
      final RegExp scriptValidator;     // regex to verify output uses correct script
    }

    class TestPrompt {
      final String category;            // e.g., "travel_directions", "travel_food", "reference"
      final String sourceText;          // English source
      final String prompt;              // Full prompt including Aya chat template tokens
      final String? expectedPattern;    // Optional regex for expected output characteristics
    }
    ```

    **Priority languages (LanguagePriority.mustHave) — extensive travel phrases:**
    - Chinese Mandarin: directions, food ordering, emergencies, greetings, prices, basic sentences, questions, requests, responses
    - Cantonese: SAME set as Mandarin but with EXPLICIT Cantonese-forcing prompt: "Translate into Cantonese (廣東話/粵語, Yue Chinese — NOT Mandarin Chinese). Include Cantonese-specific vocabulary and particles (e.g., 㗎, 囉, 喇)." Validation regex must check for Cantonese particles: `[㗎囉喇嘅咁咋㖖]`
    - Latin American Spanish: Same travel phrase categories. Prompt must specify "Latin American Spanish (NOT Castilian/European Spanish)"
    - English: Verify English-to-English paraphrasing works, plus English as source for all other translations

    **Travel phrase categories for must-have languages (5+ prompts each):**
    - Directions: "Where is the nearest subway station?", "How do I get to the airport?", "Is this the right way to [landmark]?"
    - Food: "I would like to order [dish]. How much is it?", "Do you have a menu in English?", "I am allergic to [allergen]"
    - Emergencies: "I need help, please call an ambulance", "Where is the nearest hospital?", "I lost my passport"
    - Greetings: "Hello, nice to meet you", "Thank you very much", "Excuse me, do you speak English?"
    - Prices: "How much does this cost?", "Can I pay with credit card?", "That is too expensive"
    - Basic sentences/questions/requests/responses: "What time is it?", "Where is the bathroom?", "I don't understand", "Can you repeat that?"

    **Standard languages (LanguagePriority.standard) — reference sentences:**
    Use 2-3 simple, verifiable reference sentences per language:
    - "The weather is nice today." (declarative)
    - "Where is the nearest restaurant?" (question)
    - "Please help me find my hotel." (request)

    **All 70+ languages to include (grouped by script family for organization):**

    Latin script: English, Dutch, French, Italian, Portuguese, Romanian, Spanish, Czech, Polish, Croatian, Catalan, Galician, Welsh, Irish, Basque, Slovak, Slovenian, Estonian, Finnish, Hungarian, Danish, Swedish, Norwegian, German, Latvian, Lithuanian, Maltese, Tagalog, Malay, Indonesian, Javanese, Vietnamese, Swahili, Hausa, Igbo, Malagasy, Shona, Wolof, Xhosa, Yoruba, Zulu

    Arabic script (RTL): Arabic, Persian, Urdu

    Thai script: Thai

    CJK: Chinese Mandarin, Cantonese (separate!), Japanese, Korean

    Cyrillic: Russian, Ukrainian, Bulgarian, Serbian

    Devanagari: Hindi, Marathi, Nepali

    Bengali: Bengali

    Tamil: Tamil

    Telugu: Telugu

    Gujarati: Gujarati

    Gurmukhi: Punjabi

    Khmer: Khmer

    Lao: Lao

    Burmese: Burmese (Myanmar)

    Ethiopic: Amharic

    Hebrew: Hebrew

    Greek: Greek

    Turkish: Turkish (Latin script but unique characters)

    **Prompt format:** Use the Aya chat template:
    ```
    <|START_OF_TURN_TOKEN|><|USER_TOKEN|>Translate the following into {language}: "{source_text}"<|END_OF_TURN_TOKEN|><|START_OF_TURN_TOKEN|><|CHATBOT_TOKEN|>
    ```

    **Script validators (RegExp per script family):**
    - Latin: `[\u0041-\u024F]` (basic + extended Latin)
    - Arabic: `[\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF]`
    - Thai: `[\u0E00-\u0E7F]`
    - CJK: `[\u4E00-\u9FFF\u3400-\u4DBF\u3000-\u303F]`
    - Cyrillic: `[\u0400-\u04FF]`
    - Devanagari: `[\u0900-\u097F]`
    - Bengali: `[\u0980-\u09FF]`
    - Tamil: `[\u0B80-\u0BFF]`
    - Telugu: `[\u0C00-\u0C7F]`
    - Gujarati: `[\u0A80-\u0AFF]`
    - Gurmukhi: `[\u0A00-\u0A7F]`
    - Khmer: `[\u1780-\u17FF]`
    - Lao: `[\u0E80-\u0EFF]`
    - Myanmar: `[\u1000-\u109F]`
    - Ethiopic: `[\u1200-\u137F]`
    - Hebrew: `[\u0590-\u05FF]`
    - Greek: `[\u0370-\u03FF]`
    - Japanese (includes Hiragana/Katakana + CJK): `[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]`
    - Korean (Hangul): `[\uAC00-\uD7AF\u1100-\u11FF]`

    **Export:** The file should export a top-level `const List<LanguageTestData> languageCorpus` and helper getters:
    - `List<LanguageTestData> get mustHaveLanguages` — filters to priority == mustHave
    - `List<LanguageTestData> get standardLanguages` — filters to priority == standard
    - `List<LanguageTestData> get allLanguages` — returns full corpus

    AVOID:
    - Do NOT conflate Cantonese with Chinese Traditional — they are separate entries
    - Do NOT use generic "Chinese" — always specify Mandarin or Cantonese
    - Do NOT hardcode expected translation outputs — use script validators and LLM-as-judge for quality
  </action>
  <verify>
    - File compiles without errors: `dart analyze integration_test/helpers/language_corpus.dart`
    - `languageCorpus.length >= 70` — all languages present
    - `mustHaveLanguages.length == 4` — Mandarin, Cantonese, Latin American Spanish, English
    - Each must-have language has >= 15 prompts (travel phrases across all categories)
    - Each standard language has >= 2 prompts (reference sentences)
    - Cantonese entry has explicit Cantonese-forcing prompt text and Cantonese particle validator
    - Every language has a non-null scriptValidator
  </verify>
  <done>
    A complete language corpus file exists at `integration_test/helpers/language_corpus.dart` containing all 70+ Aya-supported languages. Priority languages (Mandarin, Cantonese, Latin American Spanish, English) have extensive travel phrase coverage. Standard languages have verifiable reference sentences. Every language has a script validator regex. Cantonese is explicitly separate from Chinese Mandarin with Cantonese-specific prompt forcing and particle validation.
  </done>
</task>

</tasks>

<verification>
1. `flutter pub get` succeeds without errors
2. `flutter analyze` reports no errors
3. Android build config references NDK r28+
4. iOS entitlements file has extended-virtual-addressing
5. Language corpus contains 70+ languages with correct structure
6. Cantonese is distinct from Mandarin with separate prompts and validators
</verification>

<success_criteria>
- Flutter project at /home/max/git/bittybot compiles dependency resolution
- All platform toolchain settings correct for NDK r28+ and iOS physical device
- Language corpus has 70+ entries with script validators
- Priority languages have 15+ travel prompts each
- Project is ready for integration test development in subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/01-inference-spike/01-01-SUMMARY.md`
</output>
