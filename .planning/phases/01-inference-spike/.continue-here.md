---
phase: 01-inference-spike
task: 2
total_tasks: 3
status: in_progress
last_updated: 2026-02-25T03:24:02.008Z
---

<current_state>
Plan 01-05 (on-device hardware verification) — binding + streaming tests PASS on Galaxy A25, multilingual test partially complete (Mandarin done, 69 languages remaining). Test infrastructure significantly improved this session. Branch: `mowismtest`.
</current_state>

<completed_work>

**This session (2026-02-25):**

- **Mowism Agent Teams test:** Spawned phone-tester worker, fixed 4 ModelLoader bugs, 6/6 binding+streaming tests passed on Galaxy A25
- **x86_64 emulator attempt:** Cross-compiled libmtmd.so for x86_64, emulator too slow for inference (~2x slower than phone). Killed emulator approach.
- **AVD moved to Hercules drive:** Emulator filled root partition (20 GB). Moved `~/.android/avd/Medium_Phone.avd/` to `/mnt/4F387471588068F1/android-avd/`. AVD ini path updated. Root reclaimed to 24 GB free.
- **AVD config changed:** RAM bumped to 6144 MB, CPU cores set to 4 (was 8)
- **ReportWriter incremental flush:** `addLanguageResult()` now async, flushes to disk after each language. Partial results recoverable on kill.
- **Test overlay improvements (subagent-built):**
  - Prompt/response text logged to overlay (orange=PROMPT, white=RESPONSE)
  - Autoscroll fixed: switched to `reverse: true` ListView (no scroll management needed)
  - Rebranded to BittyBot colors from `app_colors.dart` (forest green header, lime accents, dark terminal bg)
- **Non-fatal script assertions:** Mandarin script mismatch no longer kills entire suite. Logged as `SCRIPT MISMATCH` instead.
- **Resumable multilingual test (subagent-built):**
  - `ReportWriter.loadExisting()` reads previous `spike_results.json` on startup
  - Skips already-completed languages, logs `SKIPPED (already in results)`
  - Fresh start override: `adb shell touch /data/local/tmp/bittybot_fresh_start`
- **Multilingual test partial results:** Mandarin 18/18 prompts saved to `spike_results.json` on phone. CJK script validation passed for all. Tok/s: 0.9-3.5 on Galaxy A25.
- **Prompt/response logging added to multilingual test** (both priority and standard language groups)

**Previous session bugs fixed (by phone-tester agent):**
1. `14b6c73` — Load directly from /data/local/tmp/ (skip broken 2.14 GB copy)
2. `d7ebbfa` — mainGpu=-1 for CPU-only mode
3. `d238c3b` — Share single model instance across tests (avoid OOM)
4. `fa6e52d` — clear() between generations (context window accumulation)

</completed_work>

<remaining_work>

- **Redeploy multilingual test to phone** with all latest changes (brand theme, autoscroll, prompt/response logging, non-fatal assertions, resume). The code is committed but not yet deployed — last deploy was pre-resume-feature.
- **Run multilingual test to completion** — will resume from Cantonese (Mandarin already done). 69 languages remaining. ~30-50 min on phone.
- **Investigate ANR crash:** App disconnected during Cantonese test (~13 min in). Logcat shows no OOM — likely ANR watchdog killing the app. Inference blocks main thread. May need shorter nPredict or periodic yielding.
- **Pull spike_results.json** when complete: `adb -s R5CY22C2W0Z shell "run-as com.bittybot.bittybot cat app_flutter/spike_results.json" > spike_results.json`
- **Run judge tooling** (Task 3): `tool/judge_quick.dart`, `tool/judge_full.dart`

</remaining_work>

<decisions_made>

- Emulator is useless for inference tests — phone is 2x+ faster, use Galaxy A25 for all on-device testing
- AVD lives on Hercules spinning drive at `/mnt/4F387471588068F1/android-avd/Medium_Phone.avd/`
- Script assertions made non-fatal — this test run is for collecting responses, quality evaluated later by judge tooling
- Resumable tests via `spike_results.json` read on startup — no more losing 30+ min of work on crash

</decisions_made>

<blockers>
- **ANR risk:** Inference on main thread causes ANR after extended runs. Not blocking spike completion but must be solved in Phase 4 (background isolate).
</blockers>

<context>
Galaxy A25 (SM-A256E, R5CY22C2W0Z) connected via USB, ADB working. Model at /data/local/tmp/tiny-aya-global-q4_k_m.gguf (2,143,977,056 bytes). Branch `mowismtest` has 12 commits ahead of master.

**Commits on mowismtest (in order):**
- 2adc197 wip: snapshot for mowism test branch
- 14b6c73 fix: load model directly from /data/local/tmp/
- d7ebbfa fix: set mainGpu=-1 for CPU-only mode
- d238c3b fix: share single model instance across tests
- fa6e52d fix: clear context between generations
- 32f5d31 docs: update checkpoint with hardware test results
- 649f9d8 docs: capture todo - Add live test output overlay
- 2ccd267 fix: flush ReportWriter to disk after each language result
- 6734a98 feat: show prompt and response text in test overlay
- 7de1367 feat: show prompt and response text in multilingual test overlay
- 44d4e85 fix: make multilingual script assertions non-fatal
- 3f4a1fe docs: capture todo - Two system prompt modes
- (subagent commits): autoscroll fix, brand retheme, resumable tests

**Todos captured this session:**
1. Add live test output overlay to integration test runner (DONE)
2. Two system prompt modes — translation and educational (Phase 4+)

**libmtmd.so locations:**
- arm64-v8a: `android/app/src/main/jniLibs/arm64-v8a/libmtmd.so` (gitignored)
- x86_64: `android/app/src/main/jniLibs/x86_64/libmtmd.so` (gitignored, for emulator)
- Build source: `/tmp/llama-build/llama.cpp/` and `/tmp/llama-build/build-android-{arm64,x86_64}/`
</context>

<next_action>
1. `/mow:resume-work` to restore context
2. Deploy latest code to phone: `/home/max/Android/flutter/bin/flutter test integration_test/spike_multilingual_test.dart -d R5CY22C2W0Z --no-pub`
3. It will auto-resume from Cantonese (Mandarin already in spike_results.json)
4. Monitor via overlay on phone screen
5. When complete, pull results and run judge tooling
</next_action>
