---
phase: 02-model-distribution
plan: 03
type: execute
wave: 3
depends_on:
  - 02-02
files_modified:
  - lib/main.dart
  - lib/features/model_distribution/widgets/model_loading_overlay.dart
  - lib/app.dart
autonomous: false
requirements:
  - MODL-04
  - MODL-05

must_haves:
  truths:
    - "On first launch the app shows the download screen and does not show the main app until download and verification complete"
    - "On subsequent launches the app goes straight to the main screen with greyscale logo, disabled input, and loading text while model loads"
    - "When model finishes loading the logo transitions from greyscale to full color and the text input enables"
    - "On every launch the app verifies the model file via SHA-256 before loading; a corrupted or missing file triggers the download screen"
    - "RAM check before model load warns honestly if device has less than 4 GB RAM but allows the user to proceed"
  artifacts:
    - path: "lib/main.dart"
      provides: "App entry point with ProviderScope wrapping BittyBotApp"
      contains: "ProviderScope"
    - path: "lib/app.dart"
      provides: "Root app widget with routing between download screen and main screen based on model state"
      contains: "BittyBotApp"
      min_lines: 30
    - path: "lib/features/model_distribution/widgets/model_loading_overlay.dart"
      provides: "Main screen loading state with greyscale-to-color logo transition and disabled input"
      contains: "ModelLoadingOverlay"
      min_lines: 40
  key_links:
    - from: "lib/main.dart"
      to: "lib/app.dart"
      via: "runApp wraps BittyBotApp in ProviderScope"
      pattern: "ProviderScope.*BittyBotApp"
    - from: "lib/app.dart"
      to: "lib/features/model_distribution/providers.dart"
      via: "watches modelDistributionProvider to decide which screen to show"
      pattern: "ref\\.watch.*modelDistribution"
    - from: "lib/features/model_distribution/widgets/model_loading_overlay.dart"
      to: "lib/features/model_distribution/providers.dart"
      via: "watches modelDistributionProvider for ModelReadyState to trigger logo transition"
      pattern: "ModelReadyState"
---

<objective>
Wire the app entry point, routing logic, and the model loading overlay so the app correctly routes between the download screen (first launch / missing model) and the main screen (model present), with the greyscale-to-color logo transition as the "model ready" signal.

Purpose: Complete the end-to-end first-launch and subsequent-launch flows. This is the integration layer that ties the download service (Plan 02) to the user-visible app experience.
Output: A working app that on first launch shows the download flow, and on subsequent launches shows the main screen with loading state that transitions to ready when the model is loaded.
</objective>

<execution_context>
@/home/max/.claude/mowism/workflows/execute-plan.md
@/home/max/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-model-distribution/02-RESEARCH.md
@.planning/phases/02-model-distribution/02-CONTEXT.md
@.planning/phases/02-model-distribution/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create app entry point, routing logic, and model loading overlay with greyscale-to-color transition</name>
  <files>
    lib/main.dart
    lib/app.dart
    lib/features/model_distribution/widgets/model_loading_overlay.dart
  </files>
  <action>
    1. Create (or update) `lib/main.dart`:
       ```dart
       import 'package:flutter/material.dart';
       import 'package:flutter_riverpod/flutter_riverpod.dart';
       import 'app.dart';

       void main() {
         WidgetsFlutterBinding.ensureInitialized();
         runApp(const ProviderScope(child: BittyBotApp()));
       }
       ```
       Minimal entry point. ProviderScope wraps everything for Riverpod.

    2. Create `lib/app.dart` — the root `ConsumerStatefulWidget`:

       **`BittyBotApp` widget:**
       - Returns a `MaterialApp` (not MaterialApp.router yet — Phase 3 may add GoRouter or similar)
       - Theme: dark theme placeholder. Use `ThemeData.dark().copyWith(scaffoldBackgroundColor: Color(0xFF121212))` with a comment `// TODO(phase-3): Replace with design system theme`
       - `home:` property uses a `_AppRouter` widget

       **`_AppRouter` ConsumerStatefulWidget:**
       - In `initState`: schedule `ref.read(modelDistributionProvider.notifier).initialize()` via `WidgetsBinding.instance.addPostFrameCallback`
       - In `build`: watch `modelDistributionProvider` and route based on state:
         - If state is `ModelReadyState` or `LoadingModelState`: show the main app screen (with `ModelLoadingOverlay`)
         - If state is any other state: show `DownloadScreen`
       - **Transition logic:** When state changes from a download-related state to `LoadingModelState` or `ModelReadyState`, the screen should transition. Use a simple conditional — no complex animation needed for the screen swap.

       **Main app screen (placeholder for Phase 3+):**
       - For now, create a simple `Scaffold` with:
         - AppBar with BittyBot logo (or text placeholder)
         - Body wrapped in `ModelLoadingOverlay` which overlays the loading state
         - A `TextField` at the bottom that is disabled when model is not ready
       - The main screen structure will be replaced/enhanced by Phase 3 (App Foundation) and Phase 6 (Chat UI). For now it just needs to exist so the loading overlay has something to overlay.

       **Routing rules (per user decisions):**
       - First launch (no model file): download screen appears
       - Download completes + verifies: transition to main screen with loading overlay
       - Subsequent launch (model exists): straight to main screen (no download screen), greyscale logo + disabled input while model verifies and loads
       - Subsequent launch (model corrupted/missing): download screen appears (SHA-256 fail triggers re-download)

    3. Create `lib/features/model_distribution/widgets/model_loading_overlay.dart`:

       **`ModelLoadingOverlay` ConsumerWidget:**
       - Watches `modelDistributionProvider`
       - Determines `isReady` = state is `ModelReadyState`
       - Determines `isLoading` = state is `LoadingModelState` or `VerifyingState` or `CheckingModelState`

       **Layout:**
       - A `Stack` containing:
         a. The `child` widget (the main app content passed in)
         b. An overlay that shows/hides based on loading state

       **Loading overlay content (per user decisions):**
       - Centered column:
         - BittyBot logo using `AnimatedCrossFade`:
           - `firstChild`: greyscale logo (`Image.asset('assets/logo_greyscale.png', width: 120)`)
           - `secondChild`: full color logo (`Image.asset('assets/logo_color.png', width: 120)`)
           - `crossFadeState`: `isReady ? CrossFadeState.showSecond : CrossFadeState.showFirst`
           - `duration: Duration(milliseconds: 600)`
           - NOTE: If logo assets don't exist yet (user will supply them), use placeholder icons:
             greyscale = `Icon(Icons.smart_toy, size: 80, color: Colors.grey)`
             color = `Icon(Icons.smart_toy, size: 80, color: Color(0xFF2D6A4F))` // forest green placeholder
             Wrap in a comment: `// TODO: Replace with actual logo assets when user supplies them`
         - Below logo: loading text "Loading language model..." in light grey, visible when `isLoading` is true
         - Use `AnimatedOpacity` to fade out the loading text and overlay background when `isReady` becomes true

       **Text input disabled state:**
       - The main screen's TextField should check model state: `enabled: ref.watch(modelDistributionProvider) is ModelReadyState`
       - When disabled, show placeholder text: "Loading model..." in the text field hint
       - When enabled, show placeholder text: "Type a message..." (Phase 6 refines this)

       **Per user decisions:**
       - The greyscale-to-color logo transition IS the "ready" signal — no toast or banner needed
       - Same loading state for first-launch-after-download AND every subsequent launch
       - On subsequent launches: straight to main screen, no splash

       **AnimatedCrossFade usage (per research):**
       - Use two separate PNG assets, NOT ColorFiltered with BlendMode.saturation (Flutter bug #179606 greyscales the entire screen)
       - The crossfade is between two Image.asset children

    AVOID:
    - Do NOT use `ColorFiltered` with `BlendMode.saturation` for greyscale (Flutter bug #179606)
    - Do NOT show a splash screen on subsequent launches (per user decision)
    - Do NOT add a toast or banner when model is ready — the logo transition is the signal (per user decision)
    - Do NOT implement the full chat UI here — just a minimal TextField placeholder. Phase 6 builds the real chat.
    - Do NOT add GoRouter or other routing package — simple conditional routing is sufficient for now
  </action>
  <verify>
    - `flutter analyze` reports no errors across lib/main.dart, lib/app.dart, lib/features/model_distribution/widgets/model_loading_overlay.dart
    - `grep "ProviderScope" lib/main.dart` matches
    - `grep "modelDistributionProvider" lib/app.dart` matches — confirms routing watches model state
    - `grep "AnimatedCrossFade" lib/features/model_distribution/widgets/model_loading_overlay.dart` matches — confirms greyscale-to-color transition
    - `grep "ModelReadyState" lib/features/model_distribution/widgets/model_loading_overlay.dart` matches — confirms ready detection
    - `grep "enabled.*ModelReadyState\|is ModelReadyState" lib/` -r matches somewhere — confirms text input is disabled until ready
    - `flutter build apk --debug 2>&1 | tail -5` — check that build at least starts without immediate Dart errors (full build may fail without NDK setup from Phase 1, but Dart analysis should pass)
  </verify>
  <done>
    App entry point (main.dart) wraps BittyBotApp in ProviderScope. App router (app.dart) watches model state and shows download screen for any download-related state or main screen for LoadingModel/ModelReady states. On subsequent launches with existing valid model, goes straight to main screen with loading overlay. ModelLoadingOverlay shows greyscale BittyBot logo that crossfades to full color when ModelReadyState is reached. Text input is disabled with "Loading model..." hint until ready. No splash, no toast — logo transition is the ready signal.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify download flow and loading state visually</name>
  <files></files>
  <action>
    CHECKPOINT: Human verification of the complete model distribution feature.

    What was built across Plans 01-03:
    - Download screen with progress bar, speed/ETA display, cellular warning, resume prompt, error escalation
    - App routing between download screen and main app based on model state
    - Greyscale-to-color logo loading overlay on main screen
    - SHA-256 verification on every launch
    - Background download with notifications

    Run `flutter run` on a connected device or emulator and verify:

    1. First launch flow:
       - App shows "Checking for language model..." briefly
       - Then "Preparing download..." spinner
       - Then either download starts (Wi-Fi) or cellular warning appears (cellular)
       - If download starts: verify forest green progress bar with bytes/speed/ETA below
       - Verify there is NO cancel button

    2. Background/resume flow:
       - While downloading, background the app (press home)
       - Check notification shade for download progress notification
       - Reopen the app — verify resume prompt appears (NOT auto-resume)
       - Resume prompt should show saved progress percentage

    3. Post-download:
       - After download completes: "Verifying download..." spinner appears briefly
       - Then transition to main app screen
       - Main screen shows greyscale logo (or placeholder icon) + "Loading model..." text + disabled text field
       - After model "loads" (currently instant since Phase 4 not wired): logo transitions to color, text field enables

    4. Subsequent launch:
       - Kill and reopen app
       - Goes straight to main screen (no download screen)
       - Brief checking -> verifying -> loading overlay -> ready

    5. Error handling (optional):
       - Turn off network and try — should show "No internet connection" error

    NOTE: The 2.14 GB download is real and takes time. To speed up verification, temporarily modify ModelConstants to point to a smaller test file, then verify the full download at least once before shipping.
  </action>
  <verify>
    User visually confirms:
    - Download screen renders correctly with all specified elements
    - Progress bar shows in forest green with speed and ETA
    - Cellular warning dialog appears when on cellular data
    - Resume prompt appears (not auto-resume) after interrupt
    - Post-download transition works to main screen
    - Greyscale-to-color logo transition fires on model ready
    - Text input disabled during loading, enabled when ready
  </verify>
  <done>
    User has approved the visual flow and interaction design of the complete model distribution feature. The download screen, progress indicators, dialogs, routing, and loading overlay all work as specified in the user decisions.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` reports no errors across all lib/ files
2. App launches and routes correctly based on model state
3. First launch shows download screen, not main app
4. Subsequent launch with valid model goes straight to main screen with loading overlay
5. Greyscale-to-color logo transition fires when model is ready
6. Text input is disabled during loading, enabled when ready
7. SHA-256 verification runs on every launch before model load
8. Corrupted model file triggers re-download flow
</verification>

<success_criteria>
- main.dart wraps app in ProviderScope and initializes model distribution
- App routing correctly switches between download screen and main screen based on model state
- Loading overlay shows greyscale logo + disabled input during model load
- Logo animates from greyscale to color when ModelReadyState is reached
- Text input enables only after model is ready
- No splash screen on subsequent launches
- Human verification confirms the visual flow works as specified
</success_criteria>

<output>
After completion, create `.planning/phases/02-model-distribution/02-03-SUMMARY.md`
</output>
